(function(e){function t(t){for(var r,s,o=t[0],c=t[1],u=t[2],h=0,f=[];h<o.length;h++)s=o[h],Object.prototype.hasOwnProperty.call(a,s)&&a[s]&&f.push(a[s][0]),a[s]=0;for(r in c)Object.prototype.hasOwnProperty.call(c,r)&&(e[r]=c[r]);l&&l(t);while(f.length)f.shift()();return i.push.apply(i,u||[]),n()}function n(){for(var e,t=0;t<i.length;t++){for(var n=i[t],r=!0,o=1;o<n.length;o++){var c=n[o];0!==a[c]&&(r=!1)}r&&(i.splice(t--,1),e=s(s.s=n[0]))}return e}var r={},a={app:0},i=[];function s(t){if(r[t])return r[t].exports;var n=r[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=e,s.c=r,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(n,r,function(t){return e[t]}.bind(null,r));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="/";var o=window["webpackJsonp"]=window["webpackJsonp"]||[],c=o.push.bind(o);o.push=t,o=o.slice();for(var u=0;u<o.length;u++)t(o[u]);var l=c;i.push([0,"chunk-vendors"]),n()})({0:function(e,t,n){e.exports=n("56d7")},1384:function(e,t,n){},"2cfa":function(e,t,n){},"302f":function(e,t,n){},"399c":function(e,t,n){"use strict";n("302f")},"43c1":function(e,t,n){"use strict";n("c9d3")},4678:function(e,t,n){var r={"./af":"2bfb","./af.js":"2bfb","./ar":"8e73","./ar-dz":"a356","./ar-dz.js":"a356","./ar-kw":"423e","./ar-kw.js":"423e","./ar-ly":"1cfd","./ar-ly.js":"1cfd","./ar-ma":"0a84","./ar-ma.js":"0a84","./ar-sa":"8230","./ar-sa.js":"8230","./ar-tn":"6d83","./ar-tn.js":"6d83","./ar.js":"8e73","./az":"485c","./az.js":"485c","./be":"1fc1","./be.js":"1fc1","./bg":"84aa","./bg.js":"84aa","./bm":"a7fa","./bm.js":"a7fa","./bn":"9043","./bn-bd":"9686","./bn-bd.js":"9686","./bn.js":"9043","./bo":"d26a","./bo.js":"d26a","./br":"6887","./br.js":"6887","./bs":"2554","./bs.js":"2554","./ca":"d716","./ca.js":"d716","./cs":"3c0d","./cs.js":"3c0d","./cv":"03ec","./cv.js":"03ec","./cy":"9797","./cy.js":"9797","./da":"0f14","./da.js":"0f14","./de":"b469","./de-at":"b3eb","./de-at.js":"b3eb","./de-ch":"bb71","./de-ch.js":"bb71","./de.js":"b469","./dv":"598a","./dv.js":"598a","./el":"8d47","./el.js":"8d47","./en-au":"0e6b","./en-au.js":"0e6b","./en-ca":"3886","./en-ca.js":"3886","./en-gb":"39a6","./en-gb.js":"39a6","./en-ie":"e1d3","./en-ie.js":"e1d3","./en-il":"7333","./en-il.js":"7333","./en-in":"ec2e","./en-in.js":"ec2e","./en-nz":"6f50","./en-nz.js":"6f50","./en-sg":"b7e9","./en-sg.js":"b7e9","./eo":"65db","./eo.js":"65db","./es":"898b","./es-do":"0a3c","./es-do.js":"0a3c","./es-mx":"b5b7","./es-mx.js":"b5b7","./es-us":"55c9","./es-us.js":"55c9","./es.js":"898b","./et":"ec18","./et.js":"ec18","./eu":"0ff2","./eu.js":"0ff2","./fa":"8df4","./fa.js":"8df4","./fi":"81e9","./fi.js":"81e9","./fil":"d69a","./fil.js":"d69a","./fo":"0721","./fo.js":"0721","./fr":"9f26","./fr-ca":"d9f8","./fr-ca.js":"d9f8","./fr-ch":"0e49","./fr-ch.js":"0e49","./fr.js":"9f26","./fy":"7118","./fy.js":"7118","./ga":"5120","./ga.js":"5120","./gd":"f6b4","./gd.js":"f6b4","./gl":"8840","./gl.js":"8840","./gom-deva":"aaf2","./gom-deva.js":"aaf2","./gom-latn":"0caa","./gom-latn.js":"0caa","./gu":"e0c5","./gu.js":"e0c5","./he":"c7aa","./he.js":"c7aa","./hi":"dc4d","./hi.js":"dc4d","./hr":"4ba9","./hr.js":"4ba9","./hu":"5b14","./hu.js":"5b14","./hy-am":"d6b6","./hy-am.js":"d6b6","./id":"5038","./id.js":"5038","./is":"0558","./is.js":"0558","./it":"6e98","./it-ch":"6f12","./it-ch.js":"6f12","./it.js":"6e98","./ja":"079e","./ja.js":"079e","./jv":"b540","./jv.js":"b540","./ka":"201b","./ka.js":"201b","./kk":"6d79","./kk.js":"6d79","./km":"e81d","./km.js":"e81d","./kn":"3e92","./kn.js":"3e92","./ko":"22f8","./ko.js":"22f8","./ku":"2421","./ku.js":"2421","./ky":"9609","./ky.js":"9609","./lb":"440c","./lb.js":"440c","./lo":"b29d","./lo.js":"b29d","./lt":"26f9","./lt.js":"26f9","./lv":"b97c","./lv.js":"b97c","./me":"293c","./me.js":"293c","./mi":"688b","./mi.js":"688b","./mk":"6909","./mk.js":"6909","./ml":"02fb","./ml.js":"02fb","./mn":"958b","./mn.js":"958b","./mr":"39bd","./mr.js":"39bd","./ms":"ebe4","./ms-my":"6403","./ms-my.js":"6403","./ms.js":"ebe4","./mt":"1b45","./mt.js":"1b45","./my":"8689","./my.js":"8689","./nb":"6ce3","./nb.js":"6ce3","./ne":"3a39","./ne.js":"3a39","./nl":"facd","./nl-be":"db29","./nl-be.js":"db29","./nl.js":"facd","./nn":"b84c","./nn.js":"b84c","./oc-lnc":"167b","./oc-lnc.js":"167b","./pa-in":"f3ff","./pa-in.js":"f3ff","./pl":"8d57","./pl.js":"8d57","./pt":"f260","./pt-br":"d2d4","./pt-br.js":"d2d4","./pt.js":"f260","./ro":"972c","./ro.js":"972c","./ru":"957c","./ru.js":"957c","./sd":"6784","./sd.js":"6784","./se":"ffff","./se.js":"ffff","./si":"eda5","./si.js":"eda5","./sk":"7be6","./sk.js":"7be6","./sl":"8155","./sl.js":"8155","./sq":"c8f3","./sq.js":"c8f3","./sr":"cf1e","./sr-cyrl":"13e9","./sr-cyrl.js":"13e9","./sr.js":"cf1e","./ss":"52bd","./ss.js":"52bd","./sv":"5fbd","./sv.js":"5fbd","./sw":"74dc","./sw.js":"74dc","./ta":"3de5","./ta.js":"3de5","./te":"5cbb","./te.js":"5cbb","./tet":"576c","./tet.js":"576c","./tg":"3b1b","./tg.js":"3b1b","./th":"10e8","./th.js":"10e8","./tk":"5aff","./tk.js":"5aff","./tl-ph":"0f38","./tl-ph.js":"0f38","./tlh":"cf755","./tlh.js":"cf755","./tr":"0e81","./tr.js":"0e81","./tzl":"cf51","./tzl.js":"cf51","./tzm":"c109","./tzm-latn":"b53d","./tzm-latn.js":"b53d","./tzm.js":"c109","./ug-cn":"6117","./ug-cn.js":"6117","./uk":"ada2","./uk.js":"ada2","./ur":"5294","./ur.js":"5294","./uz":"2e8c","./uz-latn":"010e","./uz-latn.js":"010e","./uz.js":"2e8c","./vi":"2921","./vi.js":"2921","./x-pseudo":"fd7e","./x-pseudo.js":"fd7e","./yo":"7f33","./yo.js":"7f33","./zh-cn":"5c3a","./zh-cn.js":"5c3a","./zh-hk":"49ab","./zh-hk.js":"49ab","./zh-mo":"3a6c","./zh-mo.js":"3a6c","./zh-tw":"90ea","./zh-tw.js":"90ea"};function a(e){var t=i(e);return n(t)}function i(e){if(!n.o(r,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return r[e]}a.keys=function(){return Object.keys(r)},a.resolve=i,e.exports=a,a.id="4678"},"4cd7":function(e,t,n){"use strict";n("5e91")},"4dc3":function(e,t,n){"use strict";n("1384")},"56d7":function(e,t,n){"use strict";n.r(t);n("4de4"),n("e260"),n("e6cf"),n("cca6"),n("a79d");var r=n("2b0e"),a=n("c1df"),i=n.n(a),s=n("5f5b"),o=n("ccac"),c=n("b1e0"),u=n("89bf"),l=n("51c2"),h=n("521d"),f=n("0c37"),d=(n("f9e3"),n("2dd8"),function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"container-fluid",attrs:{id:"app"}},[n("app-header"),n("router-view"),n("app-toaster"),n("app-player")],1)}),p=[],m=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("audio",{ref:"player",on:{ended:e.onPlayerEnded,loadeddata:e.onPlayerLoadedData,timeupdate:e.onPlayerTimeUpdate,play:e.onPlayerPlay}})},v=[];n("4160"),n("159b");function b(e){return new Date(1e3*e).toISOString().substr(14,5)}var g={data:function(){return{subscribes:[],isPlaying:!1,duration:b(0),playedTime:b(0)}},mounted:function(){var e=this;this.subscribes.push(this.$store.subscribe((function(t){"startStopPlay"===t.type?e.onStartStop():"startPlay"===t.type?e.onStart():"stopPlay"===t.type&&e.onStop()})))},beforeDestroy:function(){this.isPlaying&&this.stop(),this.resetProgress(),this.subscribes.forEach((function(e){e()}))},computed:{newSource:function(){return this.$store.state.audio.startPlay}},methods:{getSource:function(){if(this.$refs.player)return this.$refs.player.src},setSource:function(e){this.$refs.player&&(this.$refs.player.src=e)},onStartStop:function(){this.newSource?this.newSource===this.getSource()&&this.isPlaying?this.onStop():this.onStart():this.onStop()},onStart:function(){(this.getSource()||this.newSource)&&(this.newSource!==this.getSource()?(this.setSource(this.newSource),this.$store.commit("setPlayerSource",this.getSource()),this.play()):this.isPlaying||this.play())},onStop:function(){this.stop()},onPlayerPlay:function(){this.isPlaying||(this.isPlaying=!0,this.$store.commit("setPlayerState",this.isPlaying))},onPlayerEnded:function(){this.isPlaying=!1,this.$store.commit("setPlayerState",this.isPlaying),this.playedTime=b(0),this.$store.commit("setPlayerTime",this.playedTime)},onPlayerLoadedData:function(){this.$refs.player&&(this.resetProgress(),this.duration=b(this.$refs.player.duration),this.$store.commit("setPlayerDuration",this.duration))},onPlayerTimeUpdate:function(){this.$refs.player&&(this.playedTime=b(this.$refs.player.currentTime),this.$store.commit("setPlayerTime",this.playedTime))},stop:function(){this.setSource(void 0),this.$store.commit("setPlayerState",!1)},play:function(){this.getSource()&&this.$refs.player.play()},resetProgress:function(){this.duration=b(0),this.playedTime=b(0),this.$store.commit("setPlayerDuration",this.duration),this.$store.commit("setPlayerTime",this.playedTime)}}},y=g,k=n("2877"),C=Object(k["a"])(y,m,v,!1,null,null,null),w=C.exports,S=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("header",[n("b-navbar",{attrs:{toggleable:"lg",type:"dark",variant:"info"}},[n("b-navbar-brand",{attrs:{href:"#"}},[e._v(e._s(e.mainTitle))]),n("b-collapse",{attrs:{id:"nav-collapse","is-nav":""}},[n("b-navbar-nav",{staticClass:"ml-auto"},[n("b-nav-item-dropdown",{attrs:{right:""},scopedSlots:e._u([{key:"button-content",fn:function(){return[e.isLoggedIn?e._e():n("b-icon",{attrs:{icon:"person-circle",scale:"2"}}),e.isLoggedIn?n("em",[e._v(e._s(e.userButtonTitle))]):e._e()]},proxy:!0}])},[n("b-dropdown-item",{attrs:{href:"#"},on:{click:e.onUserButtonAction}},[e._v(" "+e._s(e.userAction)+" ")])],1)],1)],1)],1)],1)},x=[],j=(n("b0c0"),n("96cf"),n("1da1")),O={name:"Header",props:{title:String},data:function(){return{mainTitle:this.title?this.title:"Chat",userAction:""}},computed:{isLoggedIn:function(){return this.$store.getters.isLoggedIn},userName:function(){return this.isLoggedIn?this.$store.state.chatData.user.username:void 0},userButtonTitle:function(){return this.userName?this.userName:"Menu"}},mounted:function(){this.userAction=this.userButtonAction()},methods:{userButtonAction:function(){var e="signIn"===this.$router.currentRoute.name?"Sign Up":"Sign In";return this.isLoggedIn?"sign out":e},onUserButtonAction:function(){var e=this;return Object(j["a"])(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!e.isLoggedIn){t.next=7;break}return t.next=3,e.$router.push({name:"signIn"});case 3:return t.next=5,e.$store.dispatch("logout");case 5:t.next=14;break;case 7:if("signIn"!==e.$router.currentRoute.name){t.next=12;break}return t.next=10,e.$router.push({name:"signUp"});case 10:t.next=14;break;case 12:return t.next=14,e.$router.push({name:"signIn"});case 14:e.userAction=e.userButtonAction();case 15:case"end":return t.stop()}}),t)})))()}},watch:{isLoggedIn:function(){this.userAction=this.userButtonAction()}}},R=O,_=Object(k["a"])(R,S,x,!1,null,"093b699c",null),E=_.exports,I=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"toaster"})},T=[],$={data:function(){return{}},computed:{notification:function(){return this.$store.state.ui.notification}},watch:{notification:function(e){e&&(e.error?e.serverError?this.showError("Server Error!"):this.showError(e.message,e.title):this.showNotification(e.message,e.title))}},methods:{showError:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"ConnectionError",t=arguments.length>1?arguments[1]:void 0;this.showToast({message:e,title:t,variant:"danger",autoHideDelay:3e3})},showNotification:function(e,t){this.showToast({message:e,title:t,variant:"secondary"})},showToast:function(e){var t=e.message,n=void 0===t?"text":t,r=e.title,a=void 0===r?"Attention!":r,i=e.variant,s=void 0===i?"secondary":i,o=e.solid,c=void 0===o||o,u=e.autoHideDelay,l=void 0===u?2e3:u;this.$bvToast.toast(n,{title:a,variant:s,solid:c,autoHideDelay:l})}}},A=$,M=Object(k["a"])(A,I,T,!1,null,null,null),P=M.exports,U={components:{appHeader:E,appToaster:P,appPlayer:w}},L=U,V=(n("5c0b"),Object(k["a"])(L,d,p,!1,null,null,null)),N=V.exports,F=(n("45fc"),n("8c4f")),D=n("2f62"),H=(n("fb6a"),n("b680"),n("d3b7"),n("cfc3"),n("9a8c"),n("a975"),n("735e"),n("c1ac"),n("d139"),n("3a7b"),n("d5d6"),n("82f8"),n("e91f"),n("60bd"),n("5f96"),n("3280"),n("3fcc"),n("ca91"),n("25a1"),n("cd26"),n("3c5d"),n("2954"),n("649e"),n("219c"),n("170b"),n("b39a"),n("72f7"),n("d4ec")),z=n("bee2"),B=(n("3ca3"),n("fd87"),n("8b09"),n("ddb0"),n("2b3d"),n("db3f")),q=function(){function e(t){Object(H["a"])(this,e),this.bitRate=t.bitRate,this.sampleRate=t.sampleRate,this.dataBuffer=[],this.encoder=new B["Mp3Encoder"](1,this.sampleRate,this.bitRate)}return Object(z["a"])(e,[{key:"encode",value:function(e){for(var t=1152,n=this._convertBuffer(e),r=n.length,a=0;r>=0;a+=t){var i=n.subarray(a,a+t),s=this.encoder.encodeBuffer(i);this.dataBuffer.push(new Int8Array(s)),r-=t}}},{key:"finish",value:function(){this.dataBuffer.push(this.encoder.flush());var e=new Blob(this.dataBuffer,{type:"audio/mp3"});return this.dataBuffer=[],{id:Date.now(),blob:e,url:URL.createObjectURL(e)}}},{key:"_floatTo16BitPCM",value:function(e,t){for(var n=0;n<e.length;n+=1){var r=Math.max(-1,Math.min(1,e[n]));t[n]=r<0?32768*r:32767*r}}},{key:"_convertBuffer",value:function(e){var t=new Float32Array(e),n=new Int16Array(e.length);return this._floatTo16BitPCM(t,n),n}}]),e}(),G=(n("c19f"),n("4a9b"),function(){function e(t){Object(H["a"])(this,e),this.bufferSize=t.bufferSize||4096,this.sampleRate=t.sampleRate,this.samples=t.samples}return Object(z["a"])(e,[{key:"finish",value:function(){this._joinSamples();var e=new ArrayBuffer(44+2*this.samples.length),t=new DataView(e);this._writeString(t,0,"RIFF"),t.setUint32(4,36+2*this.samples.length,!0),this._writeString(t,8,"WAVE"),this._writeString(t,12,"fmt "),t.setUint32(16,16,!0),t.setUint16(20,1,!0),t.setUint16(22,1,!0),t.setUint32(24,this.sampleRate,!0),t.setUint32(28,4*this.sampleRate,!0),t.setUint16(32,4,!0),t.setUint16(34,16,!0),this._writeString(t,36,"data"),t.setUint32(40,2*this.samples.length,!0),this._floatTo16BitPCM(t,44,this.samples);var n=new Blob([t],{type:"audio/wav"});return{id:Date.now(),blob:n,url:URL.createObjectURL(n)}}},{key:"_floatTo16BitPCM",value:function(e,t,n){for(var r=t,a=0;a<n.length;a+=1,r+=2){var i=Math.max(-1,Math.min(1,n[a]));e.setInt16(r,i<0?32768*i:32767*i,!0)}}},{key:"_joinSamples",value:function(){for(var e=this.samples.length*this.bufferSize,t=new Float64Array(e),n=0,r=0;r<this.samples.length;r+=1){var a=this.samples[r];t.set(a,n),n+=a.length}this.samples=t}},{key:"_writeString",value:function(e,t,n){for(var r=0;r<n.length;r+=1)e.setUint8(t+r,n.charCodeAt(r))}}]),e}()),W=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Object(H["a"])(this,e),this.micFailed=t.micFailed,this.format=t.format?t.format:"mp3",this.encoderOptions={bitRate:t.bitRate?t.bitRate:128,sampleRate:t.sampleRate?t.sampleRate:44100},this.bufferSize=4096,this.record=null,this.isPause=!1,this.isRecording=!1,this.duration=0,this.volume=0,this.wavSamples=[],this._duration=0}return Object(z["a"])(e,[{key:"start",value:function(){var e={video:!1,audio:{channelCount:1,echoCancellation:!1}};navigator.mediaDevices.getUserMedia(e).then(this._micCaptured.bind(this)).catch(this._micError.bind(this)),this.isPause=!1,this.isRecording=!0,this._isMp3()&&!this.lameEncoder&&(this.lameEncoder=new q(this.encoderOptions))}},{key:"_setStateStopped",value:function(){this._duration=0,this.duration=0,this.isPause=!1,this.isRecording=!1}},{key:"stop",value:function(){if(this.stream){this.stream.getTracks().forEach((function(e){return e.stop()})),this.input.disconnect(),this.processor.disconnect(),this.context.close();var e=null;if(this._isMp3())e=this.lameEncoder.finish();else{var t=new G({bufferSize:this.bufferSize,sampleRate:this.encoderOptions.sampleRate,samples:this.wavSamples});e=t.finish(),this.wavSamples=[]}e.type=this.format,e.size=e.blob.size,e.duration=b(this.duration),this.record=e,this._setStateStopped()}else this._setStateStopped()}},{key:"pause",value:function(){this.stream?(this.stream.getTracks().forEach((function(e){return e.stop()})),this.input.disconnect(),this.processor.disconnect(),this._duration=this.duration,this.isPause=!0):this._setStateStopped()}},{key:"_micCaptured",value:function(e){var t=this;this.context=new(window.AudioContext||window.webkitAudioContext),this.duration=this._duration,this.input=this.context.createMediaStreamSource(e),this.processor=this.context.createScriptProcessor(this.bufferSize,1,1),this.stream=e,this.processor.onaudioprocess=function(e){var n=e.inputBuffer.getChannelData(0),r=0;t._isMp3()?t.lameEncoder.encode(n):t.wavSamples.push(new Float32Array(n));for(var a=0;a<n.length;a+=1)r+=n[a]*n[a];var i=parseFloat(t.context.currentTime.toFixed(2));t.duration=parseFloat(t._duration)+i,t.volume=Math.sqrt(r/n.length).toFixed(2)},this.input.connect(this.processor),this.processor.connect(this.context.destination)}},{key:"_micError",value:function(e){this.isPause=!1,this.isRecording=!1,this.record=void 0,console.debug("mic failed!"),this.micFailed&&this.micFailed(e)}},{key:"_isMp3",value:function(){return"mp3"===this.format.toLowerCase()}}]),e}(),Y={state:function(){return{recorder:void 0,currentRecord:void 0,isRecording:!1,isPlaying:!1,startPlay:"",playerSource:"",playedTime:"",playerDuration:""}},mutations:{initRecorder:function(e,t){e.recorder=new W(t)},saveRecord:function(e,t){e.currentRecord=t},setRecorderState:function(e,t){e.isRecording=t},setPlayerState:function(e,t){e.isPlaying=t},setPlayerTime:function(e,t){e.playedTime=t},setPlayerDuration:function(e,t){e.playerDuration=t},setPlayerSource:function(e,t){e.playerSource="string"===typeof t?t.slice():t},startPlay:function(e,t){e.startPlay="string"===typeof t?t.slice():t},stopPlay:function(e){e.startPlay=void 0},startStopPlay:function(e,t){e.startPlay="string"===typeof t?t.slice():t}},getters:{audioSource:function(e){return e.currentRecord?e.currentRecord.url:""}}},J=(n("4fad"),n("2909")),Q=n("3835"),K=n("5530"),X=function(){return{online:!1,userStatus:{chat:void 0,voiceChannel:void 0},draft:{},unreadMessages:{},historyLoaded:{},notification:void 0,attachedFiles:[]}},Z={state:X,mutations:{updateDraft:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";e.draft[e.currentChatId]=t.slice(),e.draft=Object(K["a"])({},e.draft)},deleteDraft:function(e,t){e.draft[t]="",e.draft=Object(K["a"])({},e.draft)},updateUserStatus:function(e,t){e.userStatus=t?Object(K["a"])({},t):t},updateUserChatStatus:function(e,t){var n=Object(K["a"])({},e.userStatus);n.chat=t,e.userStatus=n},updateUserVoiceChannelStatus:function(e,t){var n=Object(K["a"])({},e.userStatus);n.voiceChannel=t,e.userStatus=n},setUnreadMessagesCount:function(e,t){var n=t.count,r=t.chat,a=Object(K["a"])({},e.unreadMessages);a[r]=n,e.unreadMessages=a},addUnreadMessage:function(e,t){var n=Object(K["a"])({},e.unreadMessages);n[t]?n[t]+=1:n[t]=1,e.unreadMessages=n},setToDefaultsAll:function(e){var t=X();Object.entries(t).forEach((function(t){var n=Object(Q["a"])(t,2),r=n[0],a=n[1];e[r]=a}))},setHistoryLoaded:function(e,t){var n=Object(K["a"])({},e.historyLoaded);n[t]=!0,e.historyLoaded=n},updateLinkStatus:function(e,t){e.online=t},postNotification:function(e,t){e.notification=Object(K["a"])({},t)},setAttachedFiles:function(e,t){e.attachedFiles=t instanceof Array?Object(J["a"])(t):[]}},getters:{userStatus:function(e){return e.userStatus},isSystemOnline:function(e){return e.online},unreadMessagesByChatId:function(e){return function(t){return e.unreadMessages[t]}},currentDraft:function(e,t){return e.draft[t.currentChatId]},isHistoryFull:function(e,t){return!!e.historyLoaded[t.currentChatId]}},actions:{clearUnreadMessagesCount:function(e){var t=e.commit,n=e.getters,r=n.currentChatId,a=0;t("setUnreadMessagesCount",{chat:r,count:a})}}},ee=(n("99af"),n("7db0"),n("0481"),n("c975"),n("d81d"),n("4069"),n("07ac"),n("c740"),n("caad"),n("a434"),n("2532"),function(){return{voiceChannels:{},currentVoiceChannelId:void 0,inputStreams:[]}}),te={state:ee,mutations:{setCurrentVoiceChannel:function(e,t){t&&(e.currentVoiceChannelId=t.slice()),e.currentVoiceChannelId=t},updateVoiceChannels:function(e,t){e.voiceChannels=Object(K["a"])({},t)},setToDefaultsAll:function(e){var t=ee();Object.entries(t).forEach((function(t){var n=Object(Q["a"])(t,2),r=n[0],a=n[1];e[r]=a}))},setContactStream:function(e,t){var n=t.contact,r=t.stream,a=Object(J["a"])(e.inputStreams),i=a.find((function(e){return e.contact===n}));i?i.stream=r:a.push({contact:n,stream:r}),e.inputStreams=a,console.log("input streams ",e.inputStreams)},deleteContactStream:function(e,t){var n=Object(J["a"])(e.inputStreams),r=n.findIndex((function(e){return e.contact===t}));-1!==r&&n.splice(r,1),e.inputStreams=n}},getters:{currentVoiceChannelId:function(e){return e.currentVoiceChannelId},contactsWithStreams:function(e){return e.inputStreams},activeStreams:function(e){return e.inputStreams.map((function(e){return e.stream}))},voiceChannelsByCurrentVirtualServer:function(e,t){var n=t.currentVirtualServerId;if(!n)return[];var r=e.voiceChannels[n];return r||[]},currentVoiceChannel:function(e){var t=e.voiceChannels[e.currentVoiceChannelId];return Object(K["a"])({},t)},voiceChannelStatus:function(e,t){return function(e){var n=t.currentVirtualServerStatus;return n?(n=n.filter((function(t){return t.value.voiceChannel===e})).map((function(e){return e.user})),n):[]}},currentVoiceChannelStatus:function(e,t){return t.voiceChannelStatus(t.currentVirtualServerId)},getVoiceChannelContacts:function(e,t){return function(e){return t.currentVirtualServerStatus.filter((function(t){return t.value&&t.value.voiceChannel===e})).map((function(e){return e.user}))}}},actions:{setCurrentVoiceChannel:function(e,t){return Object(j["a"])(regeneratorRuntime.mark((function n(){var r;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:r=e.commit,r("setCurrentVoiceChannel",t);case 2:case"end":return n.stop()}}),n)})))()},updateStreamsByContactsOnline:function(e,t){return Object(j["a"])(regeneratorRuntime.mark((function n(){var r,a,i;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(r=e.state,a=e.dispatch,r.inputStreams.length){n.next=3;break}return n.abrupt("return");case 3:return i=r.inputStreams.filter((function(e){return!t.includes(e.contact)})),r.inputStreams=r.inputStreams.filter((function(e){return t.includes(e.contact)})),n.next=7,Promise.all(i.map((function(e){return a("disconnectContact",e.contact)})));case 7:case"end":return n.stop()}}),n)})))()}}},ne=function(){return{user:void 0,token:void 0,virtualServers:{},chats:{},chatHistory:[],status:{},contacts:[],contactsOnline:{},currentVirtualServerId:void 0,currentChatId:void 0}},re={state:ne,mutations:{setCurrentVirtualServer:function(e,t){e.currentVirtualServerId!==t&&(e.currentVirtualServerId=t.slice(),e.currentChatId=e.chats[t].length?e.chats[t][0]._id.slice():void 0)},setCurrentChat:function(e,t){e.currentChatId=t?t.slice():t},setVirtualServers:function(e,t){var n={};t.forEach((function(e){n[e._id]=Object(K["a"])({},e)})),e.virtualServers=n},setChats:function(e,t){e.chats=Object(K["a"])({},t)},saveUser:function(e,t){e.user=Object(K["a"])({},t)},saveToken:function(e,t){"string"===typeof t&&(e.token=t.slice())},updateChats:function(e,t){e.chats=Object(K["a"])({},t)},updateChatHistory:function(e,t){e.chatHistory=Object(J["a"])(t)},addChatHistoryChunk:function(e,t){if(t.length){var n=e.chatHistory.concat(t);e.chatHistory=n}},addMessage:function(e,t){var n=Object(J["a"])(e.chatHistory);n.unshift(t),e.chatHistory=n},updateStatus:function(e,t){var n=t.virtualServer,r=t.status,a=Object(K["a"])({},e.status);a[n]=r,e.status=Object(K["a"])({},a)},updateContactsOnline:function(e,t){var n=t.virtualServer,r=t.contactsOnline,a=Object(K["a"])({},e.contactsOnline);a[n]=r,e.contactsOnline=a;var i=Object.values(a).flat();i=i.filter((function(e,t){return i.indexOf(e)===t})),i=i.filter((function(t){return!e.contacts.some((function(e){return e._id===t._id}))})),i.length&&(i=e.contacts.concat(i),e.contacts=Object(J["a"])(i))},updateContacts:function(e,t){e.contacts=Object(J["a"])(t)},setToDefaultsAll:function(e){var t=ne();Object.entries(t).forEach((function(t){var n=Object(Q["a"])(t,2),r=n[0],a=n[1];e[r]=a}))}},getters:{currentVirtualServerId:function(e){return e.currentVirtualServerId},currentChatId:function(e){return e.currentChatId},usersOnline:function(e){return e.contactsOnline[e.currentVirtualServerId]},chatsByCurrentVirtualServer:function(e){if(!e.currentVirtualServerId)return[];var t=e.chats[e.currentVirtualServerId];return t||[]},isLoggedIn:function(e){return!!e.user},currentChat:function(e){var t=e.chats[e.currentChatId];return Object(K["a"])({},t)},currentVirtualServer:function(e){return e.virtualServers[e.currentVirtualServerId]},currentChatHistory:function(e){var t=e.chatHistory.filter((function(t){return t.chat===e.currentChatId}));return t?t.reverse():[]},currentHistorySize:function(e,t){return t.currentChatHistory.length},usernameById:function(e){return function(t){var n=e.contacts.find((function(e){return e._id===t}));return n?n.username:""}},currentVirtualServerStatus:function(e){return e.status[e.currentVirtualServerId]},currentChatStatus:function(e){if(!e.status[e.currentVirtualServerId])return[];var t=e.status[e.currentVirtualServerId].filter((function(t){return t.value.chat===e.currentChatId})).map((function(e){return e.user}));return t},userById:function(e){return function(t){return e.contacts.find((function(e){return e._id===t}))}}},actions:{addMessage:function(e,t){var n=e.commit;n("addMessage",t),n("addUnreadMessage",t.chat)},updateStatus:function(e,t){return Object(j["a"])(regeneratorRuntime.mark((function n(){var r,a,i,s,o,c,u;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(r=e.state,a=e.commit,i=e.dispatch,s=t.virtualServer,o=t.status,a("updateStatus",{virtualServer:s,status:o}),c=o.find((function(e){return e.user===r.user._id})),!c||!c.value){n.next=7;break}return n.next=7,i("setCurrentVoiceChannel",c.value.voiceChannel);case 7:return u=o.filter((function(e){return e.value.voiceChannel===c.value.voiceChannel})).map((function(e){return e.user})),n.next=10,i("updateStreamsByContactsOnline",u);case 10:case"end":return n.stop()}}),n)})))()},setCurrentVirtualServer:function(e,t){var n=e.commit;n("setCurrentVirtualServer",t),n("setAttachedFiles",[]),n("saveRecord",void 0)},setCurrentChat:function(e,t){var n=e.commit;n("setCurrentChat",t),n("setAttachedFiles",[]),n("saveRecord",void 0)},saveUser:function(e,t){return Object(j["a"])(regeneratorRuntime.mark((function n(){var r;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:r=e.commit,r("saveUser",t.user),r("saveToken",t.token),r("setVirtualServers",t.virtualServers);case 4:case"end":return n.stop()}}),n)})))()}},modules:{voiceChannel:te}},ae=(n("b64b"),n("ac1f"),n("5319"),n("66e8")),ie=function(){function e(t,n,r){Object(H["a"])(this,e),this.voiceChannel=r,this.contact=n,this.inputStream=void 0,this.iceQueue=[],this.createPeerConnection(t,this.voiceChannel.connectionConfig)}return Object(z["a"])(e,[{key:"createPeerConnection",value:function(e,t){var n=this;this.peerConnection=new RTCPeerConnection(t),this.peerConnection.onicecandidate=function(e){null!==e.candidate&&n.voiceChannel.sendIce(n.contact,e.candidate)},this.peerConnection.ontrack=function(e){n.inputStream||(n.inputStream=new MediaStream),e.track&&(n.inputStream.addTrack(e.track),n.voiceChannel.onInputStream(n.contact,n.inputStream))},e.getTracks().forEach((function(e){n.peerConnection.addTrack(e)}))}},{key:"connectToClient",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t,n){var r,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(e.prev=0,!t){e.next=6;break}return e.next=4,this.onOffer(t,n);case 4:e.next=18;break;case 6:return e.next=8,this.peerConnection.createOffer();case 8:return r=e.sent,e.next=11,this.peerConnection.setLocalDescription(r);case 11:return e.next=13,this.voiceChannel.sendOffer(this.contact,r);case 13:if(a=e.sent,a.answer){e.next=16;break}throw new Error("No answer from voice channel client!");case 16:return e.next=18,this.onAnswer(a.answer);case 18:e.next=23;break;case 20:e.prev=20,e.t0=e["catch"](0),this.voiceChannel.onError(e.t0);case 23:case"end":return e.stop()}}),e,this,[[0,20]])})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"close",value:function(){if(this.voiceChannel.onCloseConnection(),this.peerConnection.close(),this.inputStream){var e=this.inputStream.getTracks();e.forEach((function(e){e.stop()})),this.inputStream=void 0}}},{key:"onOffer",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t,n){var r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.peerConnection.setRemoteDescription(new RTCSessionDescription(t));case 2:return e.next=4,this.peerConnection.createAnswer();case 4:return r=e.sent,e.next=7,this.peerConnection.setLocalDescription(r);case 7:return e.next=9,this.voiceChannel.sendAnswer(this.contact,r,n);case 9:case"end":return e.stop()}}),e,this)})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"onAnswer",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t){var n,r=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.peerConnection.setRemoteDescription(new RTCSessionDescription(t));case 2:if(!this.iceQueue.length){e.next=7;break}return n=Promise.resolve(),this.iceQueue.forEach((function(e){n=n.then((function(){return r.onIce(e,!0)}))})),e.next=7,n;case 7:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"onIce",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t){var n,r=arguments;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(n=r.length>1&&void 0!==r[1]&&r[1],this.peerConnection&&this.peerConnection.remoteDescription&&this.peerConnection.remoteDescription.type){e.next=4;break}return n||this.iceQueue.push(t),e.abrupt("return",!1);case 4:return e.next=6,this.peerConnection.addIceCandidate(new RTCIceCandidate(t));case 6:return e.abrupt("return",!0);case 7:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()}]),e}(),se=n("66e8"),oe=se.ICE_SERVER_URLS,ce=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{iceServers:[{urls:oe}]},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(){},i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:function(){},s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:function(){},o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:function(){};Object(H["a"])(this,e),this.connectionConfig=t,this.sendOffer=r.bind(void 0,this.virtualServer,this.voiceChannel),this.sendIce=n.bind(void 0,this.virtualServer,this.voiceChannel),this.sendAnswer=a.bind(void 0,this.virtualServer,this.voiceChannel),this.onInputStream=i,this.onCloseConnection=s,this.onError=o,this.connections=[],this.mediaStream=void 0}return Object(z["a"])(e,[{key:"createConnection",value:function(e){var t=new ie(this.mediaStream,e,this);return this.connections.push(t),t}},{key:"connectToChannel",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t,n){var r,a=this,i=arguments;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(r=i.length>2&&void 0!==i[2]?i[2]:[],this.virtualServer=t,this.voiceChannel=n,r&&r.length){e.next=5;break}return e.abrupt("return",!0);case 5:return e.prev=5,e.next=8,this.createMediaStream();case 8:return r.forEach((function(e){a.createConnection(e)})),e.next=11,Promise.all(this.connections.map((function(e){return e.connectToClient()})));case 11:e.next=17;break;case 13:return e.prev=13,e.t0=e["catch"](5),this.onError(e.t0),e.abrupt("return",!1);case 17:return e.abrupt("return",!0);case 18:case"end":return e.stop()}}),e,this,[[5,13]])})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"disconnect",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:this.connections.forEach((function(e){e.close()})),this.connections=[],this.mediaStream&&(t=this.mediaStream.getTracks(),t.forEach((function(e){e.stop()})),this.mediaStream=void 0);case 3:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"onContactDisconnect",value:function(e){var t=this.connections.findIndex((function(t){return t.contact===e}));if(-1!==t){var n=this.connections[t];n.close(),this.connections.splice(t,1)}}},{key:"createMediaStream",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!this.mediaStream){e.next=2;break}return e.abrupt("return",!0);case 2:return e.prev=2,e.next=5,navigator.mediaDevices.getUserMedia({video:!1,audio:!0});case 5:this.mediaStream=e.sent,e.next=12;break;case 8:e.prev=8,e.t0=e["catch"](2),this.onError(e.t0),this.mediaStream=null;case 12:return e.abrupt("return",!!this.mediaStream);case 13:case"end":return e.stop()}}),e,this,[[2,8]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"onOffer",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t,n){var r,a,i,s,o;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=n.voiceChannel,a=n.user,i=n.offer,s=n.uniqueMessageId,this.virtualServer&&(this.virtualServer=t,this.voiceChannel=r),e.prev=2,e.next=5,this.createMediaStream();case 5:return o=this.createConnection(a),e.next=8,o.connectToClient(i,s);case 8:e.next=13;break;case 10:e.prev=10,e.t0=e["catch"](2),this.onError(e.t0);case 13:case"end":return e.stop()}}),e,this,[[2,10]])})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"onIce",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t){var n,r,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(n=t.user,r=t.ice,a=this.getConnectionByContact(n),e.prev=2,!a){e.next=6;break}return e.next=6,a.onIce(r);case 6:e.next=11;break;case 8:e.prev=8,e.t0=e["catch"](2),this.onError(e.t0);case 11:case"end":return e.stop()}}),e,this,[[2,8]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"getConnectionByContact",value:function(e){return this.connections.find((function(t){return t.contact===e}))}}]),e}(),ue=function(){function e(t){Object(H["a"])(this,e),this.token=t}return Object(z["a"])(e,[{key:"initToken",value:function(e){this.token=e}},{key:"status",value:function(e){return{status:e,token:this.token,action:ae["ACTIONS"].status}}},{key:"text",value:function(e,t){return{text:t,chat:e,token:this.token,action:ae["ACTIONS"].text}}},{key:"binaryInfo",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ae["ACTIONS"].audioInfo;return{binaryInfo:e,token:this.token,action:t}}},{key:"messageHeader",value:function(e,t){return{text:t.text,chat:e,token:this.token,action:ae["ACTIONS"].messageHeader}}},{key:"messageFooter",value:function(){return{token:this.token,action:ae["ACTIONS"].messageFooter}}},{key:"historyRequest",value:function(e,t){return{offset:t,chat:e,token:this.token,action:ae["ACTIONS"].getHistory}}},{key:"chatsRequest",value:function(){return{token:this.token,action:ae["ACTIONS"].getChats}}},{key:"voiceChannelsRequest",value:function(){return{token:this.token,action:ae["ACTIONS"].getVoiceChannels}}},{key:"contactsRequest",value:function(){return{token:this.token,action:ae["ACTIONS"].getContacts}}},{key:"offer",value:function(e,t,n){return{voiceChannel:e,offer:n,token:this.token,action:ae["ACTIONS"].voiceChannelOffer,to:t}}},{key:"answer",value:function(e,t,n,r){return{uniqueMessageId:r,voiceChannel:e,answer:n,token:this.token,action:ae["ACTIONS"].voiceChannelAnswer,to:t}}},{key:"ice",value:function(e,t,n){return{voiceChannel:e,ice:n,token:this.token,action:ae["ACTIONS"].voiceChannelIce,to:t}}}]),e}(),le=n("262e"),he=n("2caf"),fe=n("9072"),de=function(e){Object(le["a"])(n,e);var t=Object(he["a"])(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Internal client Error",a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:500;return Object(H["a"])(this,n),e=t.call(this,r),e.shortMsg=r,e.responseStatus=a,e}return n}(Object(fe["a"])(Error)),pe=function(e){Object(le["a"])(n,e);var t=Object(he["a"])(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Error on server! Message was not sent",r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:401;return Object(H["a"])(this,n),t.call(this,e,r)}return n}(de),me=function(e){Object(le["a"])(n,e);var t=Object(he["a"])(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Client Error",a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:500;return Object(H["a"])(this,n),e=t.call(this,r),e.shortMsg=r,e.responseStatus=a,e}return n}(Object(fe["a"])(Error)),ve={connecting:0,open:1,closing:2,closed:3},be={error:"error",message:"message",open:"open",close:"close"},ge=5e3,ye=2e4,ke=n("53ca"),Ce=n("ec26"),we=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Object(Ce["a"])(),r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];Object(H["a"])(this,e),this.payload=t,this.uuid=n,this.binarySent=r}return Object(z["a"])(e,[{key:"toString",value:function(){return JSON.stringify({payload:this.payload,uuid:this.uuid,binarySent:this.binarySent})}},{key:"type",get:function(){return Object(ke["a"])(this.payload)}}],[{key:"clone",value:function(t){return new e(t.payload,t.uuid,t.binarySent)}},{key:"fromString",value:function(t){var n=JSON.parse(t);return e.clone(n)}},{key:"fromEvent",value:function(t){return"string"===typeof t.data?e.fromString(t.data):new e(t.data)}}]),e}(),Se=we,xe=function(e){Object(le["a"])(n,e);var t=Object(he["a"])(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Connection Error",a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:500;return Object(H["a"])(this,n),e=t.call(this,r),e.shortMsg=r,e.responseStatus=a,e}return n}(Object(fe["a"])(Error)),je=function(e){Object(le["a"])(n,e);var t=Object(he["a"])(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Request timeout Error. Server is not responding!",r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:401;return Object(H["a"])(this,n),t.call(this,e,r)}return n}(xe),Oe=function(){function e(t){var n=t.url,r=t.connect,a=t.onOpenCallback,i=t.onMessageCallback,s=t.onCloseCallback,o=t.onErrorCallback;Object(H["a"])(this,e),this.url=n,this.socket=null,this.onOpenCallback=a,this.onMessageCallback=i,this.onCloseCallback=s,this.onErrorCallback=o,this.tasks=[],r&&this.connect()}return Object(z["a"])(e,[{key:"send",value:function(e){if(this.status!==ve.open)throw new Error("connection is not opened!");var t=new Se(e,e.uniqueMessageId);this.socket.send(t)}},{key:"sendBinaryAsync",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t){var n=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){var a=setTimeout((function(){r(new je)}),ye);n.addTask((function(t,n){if(n===be.error)return clearTimeout(a),setTimeout((function(){return e(null)}),0),!0;if(n===be.message){if("string"!==typeof t.data)return!1;var r=Se.fromEvent(t);return!!r.binarySent&&(clearTimeout(a),setTimeout((function(){return e(r.payload)}),0),!0)}return!1})),n.socket.send(t)})));case 1:case"end":return e.stop()}}),e)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"sendAsync",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(){var t,n,r=this,a=arguments;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t=a.length>0&&void 0!==a[0]?a[0]:{},n=a.length>1&&void 0!==a[1]?a[1]:ge,e.abrupt("return",new Promise((function(e,a){var i=new Se(t,t.uniqueMessageId),s=setTimeout((function(){a(new je)}),n);r.addTask((function(t,n){if(n===be.error)return clearTimeout(s),setTimeout((function(){return e(null)}),0),!0;if(n===be.message){if("string"!==typeof t.data)return!1;var r=Se.fromEvent(t);return i.uuid===r.uuid&&(clearTimeout(s),setTimeout((function(){if(r.payload.error)a(new de);else{var t=Object(K["a"])({},r.payload);t.uniqueMessageId=r.uuid,e(t)}}),0),!0)}return!1})),r.socket.send(i)})));case 3:case"end":return e.stop()}}),e)})));function t(){return e.apply(this,arguments)}return t}()},{key:"startTasks",value:function(e,t){if(this.tasks.length){var n=this.tasks.map((function(n){return{task:n,result:n(e,t)}}));this.tasks=n.filter((function(e){return!e.result})).map((function(e){return e.task}))}}},{key:"addTask",value:function(e){e&&this.tasks.push(e)}},{key:"onOpen",value:function(e){this.startTasks(e,be.open),this.onOpenCallback&&this.onOpenCallback(e)}},{key:"onMessage",value:function(e){this.startTasks(e,be.message);var t=Se.fromEvent(e),n=Object(K["a"])({},t.payload);n.uniqueMessageId=t.uuid,this.onMessageCallback&&this.onMessageCallback(n)}},{key:"onClose",value:function(e){this.startTasks(e,be.close),this.onCloseCallback&&this.onCloseCallback(e)}},{key:"onError",value:function(e){this.startTasks(e,be.error),this.onErrorCallback&&this.onErrorCallback(e)}},{key:"setSocketCallbacks",value:function(){if(!this.socket)throw new Error("AsyncSocket was not created! AsyncSocket Init error!");this.socket.onopen=this.onOpen.bind(this),this.socket.onmessage=this.onMessage.bind(this),this.socket.onclose=this.onClose.bind(this),this.socket.onerror=this.onError.bind(this)}},{key:"connect",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.url;if(!e)throw new Error("Bad url for websocket connection!");this.socket=new WebSocket(e),this.socket.binaryType="arraybuffer",this.setSocketCallbacks()}},{key:"connectAsync",value:function(e){var t=this;return new Promise((function(n){var r=setTimeout((function(){n(!1)}),ge);t.addTask((function(e,t){return t===be.error?(clearTimeout(r),setTimeout((function(){return n(!1)}),0),!0):t===be.open&&(clearTimeout(r),setTimeout((function(){return n(!0)}),0),!0)})),t.connect(e)}))}},{key:"disconnect",value:function(e,t){this.socket.close(e,t)}},{key:"disconnectAsync",value:function(e,t){var n=this;return new Promise((function(r){var a=setTimeout((function(){r(!0)}),ge);n.addTask((function(e,t){return(t===be.error||t===be.close)&&(clearTimeout(a),setTimeout((function(){return r(!0)}),0),!0)})),n.disconnect(e,t)}))}},{key:"status",get:function(){return this.socket?this.socket.readyState:null}}]),e}(),Re=Oe,_e=function(){function e(t,n,r){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(){},i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:function(){},s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:3;Object(H["a"])(this,e),this.virtualServerId=r,this.serverUrl=t,this.token=n,this.socket=null,this.onMessageCallback=a,this.onErrorCallback=i,this.errorsCount=0,this.errorsToReconnect=s,this.connectionStatuses=ae["CONNECTION_STATUSES"],this.connectionStatus=this.connectionStatuses.CLOSED,this.reconnectsAfterError=0}return Object(z["a"])(e,[{key:"connectToServer",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(){var t,n,r=arguments;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t=r.length>0&&void 0!==r[0]&&r[0],this.serverUrl){e.next=3;break}return e.abrupt("return",!1);case 3:return this.connectionStatus=this.connectionStatuses.OPENING,this.socket=new Re({url:this.serverUrl,onOpenCallback:this.onOpen.bind(this),onMessageCallback:this.onMessage.bind(this),onCloseCallback:this.onClose.bind(this),onErrorCallback:this.onError.bind(this)}),e.next=7,this.socket.connectAsync();case 7:if(n=e.sent,n||t){e.next=12;break}return e.next=11,this.connectToServer(!0);case 11:n=e.sent;case 12:if(!n){e.next=16;break}return e.next=15,this.sendToken();case 15:this.connectionStatus=this.connectionStatuses.OPENED;case 16:return e.abrupt("return",n);case 17:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"sendToken",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",this.socket.sendAsync({token:this.token,action:ae["ACTIONS"].userInfo}));case 1:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"disconnect",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t,n){var r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return this.connectionStatus=this.connectionStatuses.CLOSING,e.next=3,this.socket.disconnectAsync(t,n);case 3:return r=e.sent,r&&(this.connectionStatus=this.connectionStatuses.CLOSED),e.abrupt("return",r);case 6:case"end":return e.stop()}}),e,this)})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"onMessage",value:function(e){this.onMessageCallback(this.virtualServerId,e)}},{key:"onError",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t){var n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(this.errorsCount+=1,n=!1,e.prev=2,!(this.errorsCount>=this.errorsToReconnect||this.isClosed)){e.next=12;break}if(this.reconnectsAfterError){e.next=12;break}return this.reconnectsAfterError+=1,e.next=8,this.disconnect();case 8:return e.next=10,this.connectToServer();case 10:n=!e.sent,n||(this.errorsCount=0);case 12:e.next=17;break;case 14:e.prev=14,e.t0=e["catch"](2),this.onErrorCallback(this.virtualServerId,t);case 17:n&&this.onErrorCallback(this.virtualServerId,t);case 18:case"end":return e.stop()}}),e,this,[[2,14]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"onOpen",value:function(){console.log("opened virtualServer ",this.virtualServerId)}},{key:"onClose",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(){var t,n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t=this.isClosed||this.isClosing,this.connectionStatus=this.connectionStatuses.CLOSED,!t){e.next=4;break}return e.abrupt("return");case 4:return n={error:{message:"connection suddenly closed!"}},e.next=7,this.onError(n);case 7:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"isClosed",get:function(){return this.connectionStatus===this.connectionStatuses.CLOSED}},{key:"isClosing",get:function(){return this.connectionStatus===this.connectionStatuses.CLOSING}},{key:"isOpening",get:function(){return this.connectionStatus===this.connectionStatuses.OPENING}},{key:"isOpened",get:function(){return this.connectionStatus===this.connectionStatuses.OPENED}}]),e}(),Ee=_e,Ie=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(){};Object(H["a"])(this,e),this.apiUrl=t,this.wsUrl="".concat(this.apiUrl.replace("http","ws"),"/wss"),this.user=void 0,this.servers={},this.token=void 0,this.onUpdateCallback=n,this.messageGenerator=new ue,this.voiceChannel=new ce(void 0,this.sendIce.bind(this),this.sendOffer.bind(this),this.sendAnswer.bind(this),r,a,this.onException.bind(this)),this.connectToVoiceChannel=this.voiceChannel.connectToChannel.bind(this.voiceChannel),this.disconnectFromVoiceChannel=this.voiceChannel.disconnect.bind(this.voiceChannel),this.onContactDisconnect=this.voiceChannel.onContactDisconnect.bind(this.voiceChannel)}return Object(z["a"])(e,[{key:"login",value:function(){var t=Object(j["a"])(regeneratorRuntime.mark((function t(n){var r;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.postToUrl("".concat(this.apiUrl,"/users/login"),{username:n,password:"sss"});case 2:return r=t.sent,t.abrupt("return",this.initializeAuth(r));case 4:case"end":return t.stop()}}),t,this)})));function n(e){return t.apply(this,arguments)}return n}()},{key:"register",value:function(){var t=Object(j["a"])(regeneratorRuntime.mark((function t(n){var r;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.postToUrl("".concat(this.apiUrl,"/users/register"),{username:n,password:"sss"});case 2:return r=t.sent,t.abrupt("return",this.initializeAuth(r));case 4:case"end":return t.stop()}}),t,this)})));function n(e){return t.apply(this,arguments)}return n}()},{key:"initializeAuth",value:function(e){var t=this;if(!e)return null;if(!e.user)return null;this.user=Object(K["a"])({},e.user),this.token=e.token,this.messageGenerator.initToken(this.token),this.servers={},e.user.virtualServers.forEach((function(e){var n="".concat(t.wsUrl,"/").concat(e._id),r=e._id;t.servers[r]={url:n,id:r,client:new Ee(n,t.token,r,t.onMessage.bind(t),t.onError.bind(t))}}));var n=Object(J["a"])(e.user.virtualServers),r=Object(K["a"])({},e.user);delete r.virtualServers;var a=e.token.slice();return{user:r,token:a,virtualServers:n}}},{key:"connect",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(){var t,n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(e.prev=0,t=Object.values(this.servers),t.length){e.next=4;break}return e.abrupt("return",!1);case 4:return e.next=6,Promise.all(t.map((function(e){return e.client.connectToServer()})));case 6:return n=e.sent,e.abrupt("return",!n.some((function(e){return!e})));case 10:return e.prev=10,e.t0=e["catch"](0),this.onException(e.t0),e.abrupt("return",!1);case 14:case"end":return e.stop()}}),e,this,[[0,10]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"disconnect",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(){var t,n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,t=Object.values(this.servers),e.next=4,Promise.all(t.map((function(e){return e.client.disconnect()})));case 4:return n=e.sent,e.abrupt("return",!n.some((function(e){return!e})));case 8:return e.prev=8,e.t0=e["catch"](0),this.onException(e.t0),e.abrupt("return",!1);case 12:case"end":return e.stop()}}),e,this,[[0,8]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"getAllChats",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(){var t,n,r,a=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Promise.all(this.virtualServers.map((function(e){return a.getChats(e)})));case 3:return t=e.sent,n=t.flat(),r={},n.forEach((function(e){r[e.virtualServer]||(r[e.virtualServer]=[]),r[e.virtualServer].push(e)})),e.abrupt("return",r);case 10:return e.prev=10,e.t0=e["catch"](0),this.onException(e.t0),e.abrupt("return",{});case 14:case"end":return e.stop()}}),e,this,[[0,10]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"getAllVoiceChannels",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(){var t,n,r,a=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Promise.all(this.virtualServers.map((function(e){return a.getVoiceChannels(e)})));case 3:return t=e.sent,n=t.flat(),r={},n.forEach((function(e){var t=e.virtualServer;r[t]||(r[t]=[]),r[t].push(e)})),e.abrupt("return",r);case 10:return e.prev=10,e.t0=e["catch"](0),this.onException(e.t0),e.abrupt("return",{});case 14:case"end":return e.stop()}}),e,this,[[0,10]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"getAllHistory",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t){var n,r=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Promise.all(t.map((function(e){return r.getHistory(e.virtualServer,e._id,0)})));case 3:if(n=e.sent,n){e.next=6;break}return e.abrupt("return",[]);case 6:return e.abrupt("return",n.flat());case 9:return e.prev=9,e.t0=e["catch"](0),this.onException(e.t0),e.abrupt("return",[]);case 13:case"end":return e.stop()}}),e,this,[[0,9]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"onMessage",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t,n){var r,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!n.error){e.next=5;break}r=Object(K["a"])({},n),r.error.serverError=!0,e.next=15;break;case 5:if(!ae["VOICE_CHANNEL_SERVICE_ACTIONS"].includes(n.action)){e.next=15;break}if(!n.offer){e.next=11;break}return e.next=9,this.voiceChannel.onOffer(t,n);case 9:e.next=14;break;case 11:if(!n.ice){e.next=14;break}return e.next=14,this.voiceChannel.onIce(n);case 14:return e.abrupt("return");case 15:a={message:n,virtualServer:t},this.onUpdateCallback(a);case 17:case"end":return e.stop()}}),e,this)})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"onError",value:function(e,t){this.onUpdateCallback({virtualServer:e,message:{error:t}})}},{key:"sendFullMessage",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t,n,r){var a,i,s=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(r.audio||r.files){e.next=2;break}return e.abrupt("return",this.sendText(t,n,r.text));case 2:return e.prev=2,e.next=5,this.sendMessageHeader(t,n,r);case 5:if(a=e.sent,!a.error){e.next=8;break}return e.abrupt("return",void 0);case 8:if(!r.audio){e.next=11;break}return e.next=11,this.sendAudio(t,r.audio);case 11:if(!r.files){e.next=16;break}return i=Promise.resolve(),r.files.forEach((function(e){i=i.then((function(){return s.sendFile(t,e)}))})),e.next=16,i;case 16:return e.abrupt("return",this.sendMessageFooter(t));case 19:return e.prev=19,e.t0=e["catch"](2),this.onException(e.t0),e.abrupt("return",void 0);case 23:case"end":return e.stop()}}),e,this,[[2,19]])})));function t(t,n,r){return e.apply(this,arguments)}return t}()},{key:"sendFile",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t,n){var r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=Object(K["a"])({},n),delete r.file,e.abrupt("return",this.sendBinary(t,r,n.file,ae["ACTIONS"].fileInfo));case 3:case"end":return e.stop()}}),e,this)})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"sendAudio",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t,n){var r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=Object(K["a"])({},n),delete r.audio,e.abrupt("return",this.sendBinary(t,r,n.audio,ae["ACTIONS"].audioInfo));case 3:case"end":return e.stop()}}),e,this)})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"sendBinary",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t,n,r){var a,i,s,o,c=arguments;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return a=c.length>3&&void 0!==c[3]?c[3]:ae["ACTIONS"].audioInfo,e.next=3,this.sendBinaryInfo(t,n,a);case 3:if(i=e.sent,!i.error){e.next=6;break}throw new pe;case 6:if(s=this.getClient(t),s){e.next=9;break}throw new pe;case 9:return e.next=11,s.socket.sendBinaryAsync(r);case 11:if(o=e.sent,!o.error){e.next=14;break}throw new pe;case 14:return e.abrupt("return",o);case 15:case"end":return e.stop()}}),e,this)})));function t(t,n,r){return e.apply(this,arguments)}return t}()},{key:"sendBinaryInfo",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t,n){var r,a,i=arguments;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=i.length>2&&void 0!==i[2]?i[2]:ae["ACTIONS"].audioInfo,a=this.messageGenerator.binaryInfo(n,r),e.abrupt("return",this.sendMessageAsync(t,a));case 3:case"end":return e.stop()}}),e,this)})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"sendMessageHeader",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t,n,r){var a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return a=this.messageGenerator.messageHeader(n,r),e.abrupt("return",this.sendMessageAsync(t,a));case 2:case"end":return e.stop()}}),e,this)})));function t(t,n,r){return e.apply(this,arguments)}return t}()},{key:"sendMessageFooter",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t){var n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=this.messageGenerator.messageFooter(),e.abrupt("return",this.sendMessageAsync(t,n));case 2:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"sendStatus",value:function(e,t){var n=this.messageGenerator.status(t);this.sendMessage(e,n)}},{key:"sendText",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t,n,r){var a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return a=this.messageGenerator.text(n,r),e.abrupt("return",this.sendMessageAsync(t,a));case 2:case"end":return e.stop()}}),e,this)})));function t(t,n,r){return e.apply(this,arguments)}return t}()},{key:"getHistory",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t,n,r){var a,i;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return a=this.messageGenerator.historyRequest(n,r),e.next=3,this.sendMessageAsync(t,a);case 3:if(i=e.sent,i){e.next=6;break}return e.abrupt("return",[]);case 6:return e.abrupt("return",i.history);case 7:case"end":return e.stop()}}),e,this)})));function t(t,n,r){return e.apply(this,arguments)}return t}()},{key:"getChats",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t){var n,r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=this.messageGenerator.chatsRequest(),e.next=3,this.sendMessageAsync(t,n);case 3:if(r=e.sent,r){e.next=6;break}return e.abrupt("return",[]);case 6:return e.abrupt("return",r.chats);case 7:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"getVoiceChannels",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t){var n,r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=this.messageGenerator.voiceChannelsRequest(),e.next=3,this.sendMessageAsync(t,n);case 3:if(r=e.sent,r){e.next=6;break}return e.abrupt("return",[]);case 6:return e.abrupt("return",r.voiceChannels);case 7:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"getContacts",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t){var n,r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=this.messageGenerator.contactsRequest(),e.next=3,this.sendMessageAsync(t,n);case 3:if(r=e.sent,r){e.next=6;break}return e.abrupt("return",[]);case 6:return e.abrupt("return",r.contacts);case 7:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"sendOffer",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t,n,r,a){var i;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return i=this.messageGenerator.offer(n,r,a),e.abrupt("return",this.sendMessageAsync(t,i));case 2:case"end":return e.stop()}}),e,this)})));function t(t,n,r,a){return e.apply(this,arguments)}return t}()},{key:"sendAnswer",value:function(e,t,n,r,a){var i=this.messageGenerator.answer(t,n,r,a);return this.sendMessage(e,i)}},{key:"sendIce",value:function(e,t,n,r){var a=this.messageGenerator.ice(t,n,r);return this.sendMessage(e,a)}},{key:"sendMessage",value:function(e,t){var n=this.getClient(e);n||this.onException(new Error("There is not any connection to server!")),n.socket.send(t)}},{key:"sendMessageAsync",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t,n,r){var a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(a=this.getClient(t),a){e.next=4;break}return this.onException(new me("There is not any connection to server!")),e.abrupt("return",r);case 4:return e.prev=4,e.next=7,a.socket.sendAsync(n);case 7:return e.abrupt("return",e.sent);case 10:return e.prev=10,e.t0=e["catch"](4),this.onException(e.t0),e.abrupt("return",r);case 14:case"end":return e.stop()}}),e,this,[[4,10]])})));function t(t,n,r){return e.apply(this,arguments)}return t}()},{key:"getClient",value:function(e){var t=Object.values(this.servers);if(t&&t.length){if(e)return this.servers[e].client;var n=Math.round(Math.random()*(t.length-1));return t[n].client}}},{key:"onException",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];console.error(e);var n=e instanceof me,r=e instanceof de,a=e instanceof xe;t&&(n=!0);var i={error:e,clientError:n,serverError:r,connectionError:a};this.onError(void 0,i)}},{key:"virtualServers",get:function(){return this.user&&this.user.virtualServers?this.user.virtualServers.map((function(e){return e._id})):[]}}],[{key:"postToUrl",value:function(){var e=Object(j["a"])(regeneratorRuntime.mark((function e(t,n){var r,a,i;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=JSON.stringify(n),a={headers:{"Content-Type":"application/json"},method:"post",body:r},e.prev=2,e.next=5,fetch(t,a);case 5:return i=e.sent,e.next=8,i.json();case 8:return e.abrupt("return",e.sent);case 11:return e.prev=11,e.t0=e["catch"](2),this.onException(e.t0),e.abrupt("return",void 0);case 15:case"end":return e.stop()}}),e,this,[[2,11]])})));function t(t,n){return e.apply(this,arguments)}return t}()}]),e}(),Te=Ie,$e=function(){return{chatClient:void 0,voiceChannelOnline:!1}},Ae={state:$e,mutations:{createChatEngine:function(e,t){var n=t.apiUrl,r=t.onUpdateCallback,a=t.onInputStreamCallback;e.chatClient=new Te(n,r,a)},setToDefaultsAll:function(e){var t=$e();Object.entries(t).forEach((function(t){var n=Object(Q["a"])(t,2),r=n[0],a=n[1];e[r]=a}))},setVoiceChannelState:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e.voiceChannelOnline=t}},getters:{isChatEngineInitialized:function(e){return!!e.chatClient}},actions:{sendUserStatus:function(e){return Object(j["a"])(regeneratorRuntime.mark((function t(){var n,r;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:n=e.state,r=e.getters,n.chatClient.sendStatus(r.currentVirtualServerId,r.userStatus);case 2:case"end":return t.stop()}}),t)})))()},updateUserChatStatus:function(e,t){return Object(j["a"])(regeneratorRuntime.mark((function n(){var r,a;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.commit,a=e.dispatch,r("updateUserChatStatus",t),n.next=4,a("sendUserStatus");case 4:case"end":return n.stop()}}),n)})))()},updateUserVoiceChannelStatus:function(e,t){return Object(j["a"])(regeneratorRuntime.mark((function n(){var r,a;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.commit,a=e.dispatch,r("updateUserVoiceChannelStatus",t),n.next=4,a("sendUserStatus");case 4:case"end":return n.stop()}}),n)})))()},updateUserStatus:function(e,t){return Object(j["a"])(regeneratorRuntime.mark((function n(){var r,a;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.commit,a=e.dispatch,r("updateUserStatus",t),n.next=4,a("sendUserStatus");case 4:case"end":return n.stop()}}),n)})))()},initChatClient:function(e,t){return Object(j["a"])(regeneratorRuntime.mark((function n(){var r,a,i,s,o;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(r=e.state,a=e.commit,i=t.apiUrl,s=t.onUpdateCallback,o=t.onInputStreamCallback,!r.chatClient){n.next=4;break}return n.abrupt("return");case 4:a("createChatEngine",{apiUrl:i,onUpdateCallback:s,onInputStreamCallback:o});case 5:case"end":return n.stop()}}),n)})))()},login:function(e,t){return Object(j["a"])(regeneratorRuntime.mark((function n(){var r,a,i,s,o,c;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(r=e.state,a=e.commit,i=e.dispatch,s=t.user,o=t.password,r.chatClient){n.next=4;break}return n.abrupt("return");case 4:return n.prev=4,n.next=7,r.chatClient.login(s,o);case 7:if(c=n.sent,c){n.next=11;break}return a("postNotification",{error:!0,message:"Wrong username or password!"}),n.abrupt("return");case 11:return n.next=13,i("saveUser",c);case 13:n.next=18;break;case 15:n.prev=15,n.t0=n["catch"](4),a("postNotification",{error:!0});case 18:case"end":return n.stop()}}),n,null,[[4,15]])})))()},connectToServer:function(e){return Object(j["a"])(regeneratorRuntime.mark((function t(){var n,r,a,i;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n=e.state,r=e.getters,a=e.commit,r.isLoggedIn){t.next=3;break}return t.abrupt("return");case 3:return t.prev=3,t.next=6,n.chatClient.connect();case 6:i=t.sent,i||a("postNotification",{error:!0}),a("updateLinkStatus",i),t.next=14;break;case 11:t.prev=11,t.t0=t["catch"](3),a("postNotification",{error:!0});case 14:case"end":return t.stop()}}),t,null,[[3,11]])})))()},register:function(e,t){return Object(j["a"])(regeneratorRuntime.mark((function n(){var r,a,i,s,o,c;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(r=e.state,a=e.commit,i=e.dispatch,s=t.user,o=t.password,r.chatClient){n.next=4;break}return n.abrupt("return");case 4:return n.prev=4,n.next=7,r.chatClient.register(s,o);case 7:if(c=n.sent,c){n.next=11;break}return a("postNotification",{error:!0,message:"Wrong username or password!"}),n.abrupt("return");case 11:return n.next=13,i("saveUser",c);case 13:n.next=19;break;case 15:n.prev=15,n.t0=n["catch"](4),console.error(n.t0),a("postNotification",{error:!0});case 19:case"end":return n.stop()}}),n,null,[[4,15]])})))()},logout:function(e){return Object(j["a"])(regeneratorRuntime.mark((function t(){var n,r,a;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.state,r=e.commit,t.next=3,n.chatClient.disconnect();case 3:a=t.sent,a&&r("setToDefaultsAll");case 5:case"end":return t.stop()}}),t)})))()},connectToVoiceChannel:function(e,t){return Object(j["a"])(regeneratorRuntime.mark((function n(){var r,a,i,s,o,c,u,l,h;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(r=e.state,a=e.getters,i=e.commit,s=e.dispatch,o=e.rootState,!r.voiceChannelOnline){n.next=9;break}return c=a.currentVoiceChannelId,n.next=5,s("disconnectFromVoiceChannel");case 5:return n.next=7,s("updateUserVoiceChannelStatus",void 0);case 7:if(c!==t){n.next=9;break}return n.abrupt("return");case 9:return u=a.getVoiceChannelContacts(t),n.next=12,r.chatClient.connectToVoiceChannel(o.chatData.currentVirtualServerId,t,u);case 12:return l=n.sent,h=l?t:void 0,n.next=16,s("updateUserVoiceChannelStatus",h);case 16:i("setVoiceChannelState",l);case 17:case"end":return n.stop()}}),n)})))()},disconnectFromVoiceChannel:function(e){return Object(j["a"])(regeneratorRuntime.mark((function t(){var n,r,a;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.state,r=e.commit,a=e.dispatch,t.next=3,n.chatClient.disconnectFromVoiceChannel();case 3:return t.next=5,a("updateUserVoiceChannelStatus",void 0);case 5:r("setVoiceChannelState",!1);case 6:case"end":return t.stop()}}),t)})))()},initializeAllChatUI:function(e){return Object(j["a"])(regeneratorRuntime.mark((function t(){var n,r,a,i,s,o,c,u,l,h;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.commit,r=e.state,a=e.dispatch,i=e.rootState,t.next=3,r.chatClient.getContacts();case 3:return s=t.sent,s&&n("updateContacts",s),t.next=7,r.chatClient.getAllChats();case 7:if(o=t.sent,!o){t.next=15;break}return n("updateChats",o),c=Object.values(o).flat(),t.next=13,r.chatClient.getAllHistory(c);case 13:u=t.sent,u&&n("updateChatHistory",u);case 15:return t.next=17,r.chatClient.getAllVoiceChannels();case 17:l=t.sent,l&&n("updateVoiceChannels",l),h=i.chatData.virtualServers,Object.values(h).length&&a("setCurrentVirtualServer",Object.keys(h)[0]);case 21:case"end":return t.stop()}}),t)})))()},disconnectContact:function(e,t){var n=e.state;n.chatClient.onContactDisconnect(t)},getHistoryChunk:function(e){return Object(j["a"])(regeneratorRuntime.mark((function t(){var n,r,a,i,s,o,c;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.commit,r=e.state,a=e.getters,i=a.currentChatId,s=a.currentVirtualServerId,o=a.currentHistorySize,t.prev=4,t.next=7,r.chatClient.getHistory(s,i,o);case 7:c=t.sent,c&&c.length||n("setHistoryLoaded",i),c&&n("addChatHistoryChunk",c),t.next=15;break;case 12:t.prev=12,t.t0=t["catch"](4),console.debug("history chunk error ",t.t0);case 15:case"end":return t.stop()}}),t,null,[[4,12]])})))()}}};r["default"].use(D["a"]);var Me=function(){return{}},Pe=new D["a"].Store({state:Me(),actions:{afterMessageSending:function(e){return Object(j["a"])(regeneratorRuntime.mark((function t(){var n,r;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.commit,r=e.dispatch,n("setAttachedFiles",[]),n("saveRecord",void 0),t.next=5,r("updateUserChatStatus",void 0);case 5:case"end":return t.stop()}}),t)})))()}},modules:{audio:Y,ui:Z,chatEngine:Ae,chatData:re}}),Ue=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"flex-grow-1"},[n("div",{staticClass:"w-100 h-100 d-flex justify-content-center align-items-center"},[e.show?n("b-form",{staticClass:"h-100 d-flex flex-column justify-content-center align-items-stretch",on:{submit:e.onSubmit,reset:e.onReset}},[n("b-form-group",{attrs:{id:"input-group-2",label:"Your Name:","label-for":"input-2"}},[n("b-form-input",{attrs:{id:"input-2",placeholder:"Enter name",required:""},model:{value:e.form.username,callback:function(t){e.$set(e.form,"username",t)},expression:"form.username"}})],1),n("div",{staticClass:"buttons"},[n("b-button",{attrs:{type:"reset",variant:"danger"}},[e._v("Reset")]),n("b-button",{staticClass:"ml-2",attrs:{type:"submit",variant:"primary"}},[e._v("Sign Up")])],1)],1):e._e()],1)])},Le=[];function Ve(e){return Ne.apply(this,arguments)}function Ne(){return Ne=Object(j["a"])(regeneratorRuntime.mark((function e(t){var n,r,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(n=t.message,r=t.virtualServer,!n.error){e.next=5;break}return a={error:n.error,serverError:!!n.serverError,message:void 0,title:void 0},Pe.commit("postNotification",a),e.abrupt("return");case 5:if(n.contactsOnline&&Pe.commit("updateContactsOnline",{virtualServer:r,contactsOnline:n.contactsOnline}),!(n.text||n.files||n.audio)||!n.date){e.next=9;break}return e.next=9,Pe.dispatch("addMessage",n);case 9:if(!n.status){e.next=12;break}return e.next=12,Pe.dispatch("updateStatus",{virtualServer:r,status:n.status});case 12:case"end":return e.stop()}}),e)}))),Ne.apply(this,arguments)}function Fe(e,t){return De.apply(this,arguments)}function De(){return De=Object(j["a"])(regeneratorRuntime.mark((function e(t,n){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:n?Pe.commit("setContactStream",{contact:t,stream:n}):Pe.commit("deleteContactStream",t);case 1:case"end":return e.stop()}}),e)}))),De.apply(this,arguments)}var He="".concat(window.location.origin,"/api"),ze=("".concat(He,"/users/login"),"".concat(He,"/users/register"),3e3),Be=5,qe={name:"signUp",components:{},data:function(){return{form:{username:"",password:""},show:!0}},computed:{isOnline:function(){return this.$store.getters.isSystemOnline}},methods:{onSubmit:function(e){var t=this;return Object(j["a"])(regeneratorRuntime.mark((function n(){return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return e.preventDefault(),n.next=3,t.signUp();case 3:case"end":return n.stop()}}),n)})))()},onReset:function(e){var t=this;e.preventDefault(),this.form.username="",this.form.password="",this.show=!1,this.$nextTick((function(){t.show=!0}))},signUp:function(){var e=this;return Object(j["a"])(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.$store.dispatch("initChatClient",{apiUrl:He,onUpdateCallback:Ve,onInputStreamCallback:Fe});case 2:return t.next=4,e.$store.dispatch("register",{user:e.form.username,password:e.form.password});case 4:return t.next=6,e.$store.dispatch("connectToServer");case 6:if(!e.isOnline){t.next=9;break}return t.next=9,e.$router.push({name:"home"});case 9:case"end":return t.stop()}}),t)})))()}}},Ge=qe,We=(n("ebcb"),Object(k["a"])(Ge,Ue,Le,!1,null,"5c97ca6d",null)),Ye=We.exports,Je=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"flex-grow-1"},[n("div",{staticClass:"w-100 h-100 d-flex justify-content-center align-items-center"},[e.show?n("b-form",{staticClass:"h-100 d-flex flex-column justify-content-center align-items-stretch",on:{submit:e.onSubmit,reset:e.onReset}},[n("b-form-group",{attrs:{id:"input-group-2",label:"Your Name:","label-for":"input-2"}},[n("b-form-input",{attrs:{id:"input-2",placeholder:"Enter name",required:""},model:{value:e.form.username,callback:function(t){e.$set(e.form,"username",t)},expression:"form.username"}})],1),n("div",{staticClass:"buttons"},[n("b-button",{attrs:{type:"reset",variant:"danger"}},[e._v("Reset")]),n("b-button",{staticClass:"ml-2",attrs:{type:"submit",variant:"primary"}},[e._v("Sign In")])],1)],1):e._e()],1)])},Qe=[],Ke={name:"signIn",components:{},data:function(){return{form:{username:"",password:""},show:!0}},computed:{isOnline:function(){return this.$store.getters.isSystemOnline}},methods:{onSubmit:function(e){var t=this;return Object(j["a"])(regeneratorRuntime.mark((function n(){return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return e.preventDefault(),n.next=3,t.signIn();case 3:case"end":return n.stop()}}),n)})))()},onReset:function(e){var t=this;e.preventDefault(),this.form.username="",this.form.password="",this.show=!1,this.$nextTick((function(){t.show=!0}))},signIn:function(){var e=this;return Object(j["a"])(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.$store.dispatch("initChatClient",{apiUrl:He,onUpdateCallback:Ve,onInputStreamCallback:Fe});case 2:return t.next=4,e.$store.dispatch("login",{user:e.form.username,password:e.form.password});case 4:return t.next=6,e.$store.dispatch("connectToServer");case 6:if(!e.isOnline){t.next=9;break}return t.next=9,e.$router.push({name:"home"});case 9:case"end":return t.stop()}}),t)})))()}}},Xe=Ke,Ze=(n("43c1"),Object(k["a"])(Xe,Je,Qe,!1,null,"1329e16d",null)),et=Ze.exports,tt=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("main",{staticClass:"flex-grow-1 row"},[n("div",{staticClass:"col-3 p-2 list-column"},[n("app-chat-list",{staticClass:"chat-list-block"}),n("app-voice-channel-list",{staticClass:"voice-channel-list-block"})],1),n("div",{staticClass:"col-7 p-2"},[n("router-view")],1),n("div",{staticClass:"col-2 p-2"},[n("app-user-list")],1)])},nt=[],rt=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"chat-list p-3"},[n("b-list-group",e._l(e.chats,(function(e){return n("app-chat-name",{key:e._id,attrs:{chatObject:e}})})),1)],1)},at=[],it=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("b-list-group-item",{staticClass:"d-flex flex-row justify-content-center align-items-center",attrs:{button:"",active:e.isActive},on:{click:e.onClick}},[n("p",{staticClass:"m-0"},[e._v(e._s(e.chat.name))]),e.unreadMessages?n("b-badge",{staticClass:"ml-2",attrs:{variant:e.isActive?"light":"primary",pill:""}},[e._v(" "+e._s(e.unreadMessages)+" ")]):e._e()],1)},st=[],ot={name:"ChatName",props:{chatObject:Object},data:function(){return{chat:this.chatObject}},computed:{isActive:function(){return this.chat._id===this.$store.state.chatData.currentChatId},unreadMessages:function(){return this.$store.getters.unreadMessagesByChatId(this.chat._id)}},methods:{onClick:function(){var e=this;return Object(j["a"])(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.$store.dispatch("setCurrentChat",e.chat._id);case 2:if("chat"===e.$route.name){t.next=5;break}return t.next=5,e.$router.push({name:"chat"});case 5:case"end":return t.stop()}}),t)})))()}}},ct=ot,ut=Object(k["a"])(ct,it,st,!1,null,"4dc6cb92",null),lt=ut.exports,ht={name:"ChatList",data:function(){return{}},computed:{chats:function(){return this.$store.getters.chatsByCurrentVirtualServer}},components:{appChatName:lt}},ft=ht,dt=Object(k["a"])(ft,rt,at,!1,null,"7159b892",null),pt=dt.exports,mt=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"chat-list p-3"},e._l(e.users,(function(e,t){return n("app-user-name",{key:t,attrs:{user:e}})})),1)},vt=[],bt=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"my-2 d-flex flex-row align-items-center justify-content-end"},[n("h6",{staticClass:"alert-heading mb-0"},[e._v(e._s(e.name))]),n("div",{staticClass:"pl-3"},[n("b-avatar",{attrs:{variant:"primary",text:e.initials}})],1)])},gt=[],yt=(n("a15b"),n("1276"),{name:"UserName",props:{user:Object},data:function(){return{}},computed:{name:function(){return this.user.username},initials:function(){var e=this.name;return e?"string"!==typeof e?"":e.split(" ").map((function(e){return e.toUpperCase()[0]})).splice(0,2).join(""):""}}}),kt=yt,Ct=Object(k["a"])(kt,bt,gt,!1,null,"25911002",null),wt=Ct.exports,St={name:"UserList",data:function(){return{}},computed:{users:function(){return this.$store.getters.usersOnline}},components:{appUserName:wt}},xt=St,jt=Object(k["a"])(xt,mt,vt,!1,null,"039659e0",null),Ot=jt.exports,Rt=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"voice-channel-list p-3"},[n("b-list-group",[e._l(e.voiceChannels,(function(e){return[n("app-chat-name",{key:e._id,attrs:{voiceChannel:e}}),n("app-contact-list",{key:e._id,attrs:{voiceChannel:e}})]}))],2)],1)},_t=[],Et=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("b-list-group-item",{directives:[{name:"b-hover",rawName:"v-b-hover",value:e.hoverHandler,expression:"hoverHandler"}],staticClass:"d-flex flex-row justify-content-center align-items-center",attrs:{button:"",active:e.isListening},on:{click:e.onClick}},[n("p",{staticClass:"m-0"},[e._v(e._s(e.voiceChannel.name))]),!e.isListening&&e.isHovered?n("b-badge",{staticClass:"ml-3",attrs:{variant:"success"}},[n("b-icon",{attrs:{icon:"telephone-fill","aria-hidden":"true"}})],1):e._e(),e.isListening&&e.isActive&&e.isHovered?n("b-badge",{staticClass:"ml-3",attrs:{variant:"danger"}},[n("b-icon",{attrs:{icon:"telephone-x-fill","aria-hidden":"true"}})],1):e._e()],1)},It=[],Tt={name:"VoiceChannelName",props:{voiceChannel:Object},data:function(){return{isHovered:!1}},computed:{isActive:function(){return"voiceChannel"===this.$route.name},isListening:function(){return this.voiceChannel._id===this.$store.getters.currentVoiceChannelId}},methods:{hoverHandler:function(e){this.isHovered=e},onClick:function(){var e=this;return Object(j["a"])(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!e.isListening){t.next=12;break}if(!e.isActive){t.next=6;break}return t.next=4,e.$store.dispatch("disconnectFromVoiceChannel");case 4:t.next=10;break;case 6:return t.next=8,e.$store.dispatch("setCurrentChat",void 0);case 8:return t.next=10,e.$router.push({name:"voiceChannel"});case 10:t.next=14;break;case 12:return t.next=14,e.$store.dispatch("connectToVoiceChannel",e.voiceChannel._id);case 14:case"end":return t.stop()}}),t)})))()}}},$t=Tt,At=Object(k["a"])($t,Et,It,!1,null,"5914635a",null),Mt=At.exports,Pt=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"contact p-3"},[e._l(e.voiceChannelContacts,(function(e){return n("app-contact",{key:e._id,attrs:{user:e}})})),e.isListening?n("div",{staticClass:"audio-streams"},e._l(e.activeStreams,(function(e){return n("app-audio-stream",{key:e.id,attrs:{stream:e}})})),1):e._e()],2)},Ut=[],Lt=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("audio",{ref:"audio",attrs:{autoplay:""}})},Vt=[],Nt={name:"AudioStream",props:{stream:MediaStream},data:function(){return{}},mounted:function(){console.log("stream ",this.stream),this.$refs.audio.srcObject=this.stream},beforeDestroy:function(){this.$refs.audio.srcObject=void 0}},Ft=Nt,Dt=Object(k["a"])(Ft,Lt,Vt,!1,null,null,null),Ht=Dt.exports,zt={name:"ContactList",components:{appContact:wt,appAudioStream:Ht},props:{voiceChannel:Object},data:function(){return{}},computed:{voiceChannelContacts:function(){var e=this;return this.$store.getters.getVoiceChannelContacts(this.voiceChannel._id).map((function(t){return e.$store.getters.userById(t)}))},isListening:function(){return this.$store.getters.currentVoiceChannelId===this.voiceChannel._id},activeStreams:function(){return console.log("activeStreams ",this.$store.getters.activeStreams),this.$store.getters.activeStreams},usersOnline:function(){return this.$store.getters.usersOnline}}},Bt=zt,qt=Object(k["a"])(Bt,Pt,Ut,!1,null,null,null),Gt=qt.exports,Wt={name:"VoiceChannelList",components:{appContactList:Gt,appChatName:Mt},data:function(){return{}},computed:{voiceChannels:function(){return this.$store.getters.voiceChannelsByCurrentVirtualServer}}},Yt=Wt,Jt=Object(k["a"])(Yt,Rt,_t,!1,null,"da60b254",null),Qt=Jt.exports,Kt={name:"Home",components:{appChatList:pt,appUserList:Ot,appVoiceChannelList:Qt},beforeMount:function(){var e=this;return Object(j["a"])(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.$store.dispatch("initializeAllChatUI");case 2:case"end":return t.stop()}}),t)})))()}},Xt=Kt,Zt=(n("4dc3"),Object(k["a"])(Xt,tt,nt,!1,null,"1853a032",null)),en=Zt.exports,tn=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("section",{staticClass:"chat d-flex flex-column h-100"},[n("app-history"),n("app-status"),n("app-new-message")],1)},nn=[],rn=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("section",{staticClass:"flex-grow-1",attrs:{id:"chat-history"}},[n("div",{ref:"chatHistory",staticClass:"chat-history__wrapper h-100 w-100 p-4",attrs:{scrolltop:e.scrollTop},on:{scroll:e.onScroll,wheel:e.onUserInput,keydown:e.onUserInput,mousedown:e.onUserInput}},e._l(e.chatHistory,(function(e,t){return n("app-message",{key:t,attrs:{message:e}})})),1)])},an=[],sn=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"message my-2 row"},[n("div",{staticClass:"user mx-0 d-flex flex-row align-items-center justify-content-end col-3",class:e.usernameClass},[n("h6",{staticClass:"alert-heading mb-0"},[e._v(e._s(e.username))]),n("b-avatar",{staticClass:"ml-2",attrs:{variant:"primary",text:e.initials}})],1),n("b-alert",{staticClass:"message-block mb-0 d-flex justify-content-between\n        flex-column align-items-stretch col-9 pb-0",attrs:{show:"",variant:"secondary"}},[e.message.text?n("p",{staticClass:"mb-1"},[e._v(e._s(e.message.text))]):e._e(),e.attached&&e.message.text?n("hr"):e._e(),e.message.audio?n("app-audio",{staticClass:"mb-1",attrs:{audio:e.message.audio}}):e._e(),e.message.files&&e.message.files.length?n("app-files",{staticClass:"mb-1",attrs:{files:e.message.files}}):e._e(),n("hr"),n("p",{staticClass:"time mb-0"},[e._v(e._s(e._f("myDate")(e.message.date)))])],1)],1)},on=[],cn=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"d-flex flex-row-reverse"},[n("b-button",{staticClass:"mt-1 d-flex flex-row align-items-center justify-content-center",attrs:{variant:"info"},on:{click:e.download}},[e.isOnPlayer?e._e():n("p",{staticClass:"mb-0"},[e._v(e._s(e.size)+" Mb")]),e.isOnPlayer?n("p",{staticClass:"mb-0"},[e._v(e._s(e.playedTime)+" / "+e._s(e.audio.duration))]):e._e(),n("b-icon",{staticClass:"ml-3",attrs:{icon:"soundwave",scale:"2",animation:e.iconAnimation}})],1)],1)},un=[],ln=n("cc1d"),hn=n.n(ln),fn={name:"Audio",props:{audio:{type:Object}},data:function(){return{downloadLink:void 0}},methods:{download:function(){var e=this;return Object(j["a"])(regeneratorRuntime.mark((function t(){var n,r,a,i;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!e.downloadLink){t.next=3;break}return e.$store.commit("startStopPlay",e.downloadLink),t.abrupt("return");case 3:return t.prev=3,t.next=6,fetch("".concat(He,"/audios/").concat(e.audio._id),{headers:{Authorization:"Bearer ".concat(e.token)}});case 6:if(n=t.sent,!n.ok){t.next=11;break}return t.next=10,n.arrayBuffer();case 10:r=t.sent;case 11:r&&(a=new DataView(r),i=new Blob([a],{type:hn.a.lookup(e.audio.type)}),e.downloadLink=URL.createObjectURL(i)),e.$store.commit("startPlay",e.downloadLink),t.next=18;break;case 15:t.prev=15,t.t0=t["catch"](3),e.$store.commit("postNotification",{error:!0,message:"Audio download error!"});case 18:case"end":return t.stop()}}),t,null,[[3,15]])})))()}},beforeDestroy:function(){this.isOnPlayer&&this.$store.commit("stopPlay"),window.URL.revokeObjectURL(this.downloadLink)},computed:{iconAnimation:function(){return this.isPlaying&&this.isOnPlayer?"fade":void 0},isPlaying:function(){return this.$store.state.audio.isPlaying},playerSource:function(){return this.$store.state.audio.playerSource},isOnPlayer:function(){return!!this.downloadLink&&this.downloadLink===this.playerSource},playedTime:function(){return this.$store.state.audio.playedTime},token:function(){return this.$store.state.chatData.token},size:function(){return Math.round(100*this.audio.size/1024/1024)/100}}},dn=fn,pn=Object(k["a"])(dn,cn,un,!1,null,null,null),mn=pn.exports,vn=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[n("div",{staticClass:"w-100 d-flex flex-row-reverse"},[n("b-button",{staticClass:"d-block",attrs:{variant:"info"},on:{click:function(t){e.visibility=!e.visibility}}},[e._v("Attached files")])],1),n("div",{staticClass:"files d-flex flow-column align-items-stretch"},[n("b-collapse",{staticClass:"mt-2 w-100",model:{value:e.visibility,callback:function(t){e.visibility=t},expression:"visibility"}},[n("b-card",e._l(e.files,(function(e,t){return n("app-file",{key:t,attrs:{file:e}})})),1)],1)],1)])},bn=[],gn=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[n("div",{staticClass:"file row mb-2"},[n("p",{directives:[{name:"b-tooltip",rawName:"v-b-tooltip.hover",modifiers:{hover:!0}}],staticClass:"file-name mb-0 col-8 p-0",attrs:{title:e.file.filename}},[e._v(" "+e._s(e.file.filename)+" ")]),n("p",{staticClass:"mb-0 col-3 p-0"},[n("b",[e._v(e._s(e.size)+" Mb")])]),n("div",{staticClass:"col-1 p-0"},[n("b-button",{staticClass:"d-flex align-items-center justify-content-center p-1",attrs:{variant:"outline-info"},on:{click:e.download}},[n("b-icon",{attrs:{icon:"download",scale:"1"}})],1)],1)]),n("a",{directives:[{name:"b-visible",rawName:"v-b-visible",value:!1,expression:"false"}],ref:"downloadAnchor",attrs:{href:""}})])},yn=[],kn={name:"File",props:{file:{type:Object}},data:function(){return{downloadLink:void 0}},beforeDestroy:function(){window.URL.revokeObjectURL(this.downloadLink)},methods:{download:function(){var e=this;return Object(j["a"])(regeneratorRuntime.mark((function t(){var n,r,a,i;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!e.downloadLink){t.next=3;break}return e.$refs.downloadAnchor.click(),t.abrupt("return");case 3:return t.prev=3,t.next=6,fetch("".concat(He,"/files/").concat(e.file._id),{headers:{Authorization:"Bearer ".concat(e.token)}});case 6:if(n=t.sent,!n.ok){t.next=11;break}return t.next=10,n.arrayBuffer();case 10:r=t.sent;case 11:r&&(a=new DataView(r),i=new Blob([a],{type:hn.a.lookup(e.file.filename)}),window.navigator.msSaveOrOpenBlob?window.navigator.msSaveOrOpenBlob(i,e.file.filename):(e.downloadLink=URL.createObjectURL(i),e.$refs.downloadAnchor.href=e.downloadLink,e.$refs.downloadAnchor.download=e.file.filename,e.$refs.downloadAnchor.click())),t.next=17;break;case 14:t.prev=14,t.t0=t["catch"](3),e.$store.commit("postNotification",{error:!0,message:"File download error!"});case 17:case"end":return t.stop()}}),t,null,[[3,14]])})))()}},computed:{token:function(){return this.$store.state.chatData.token},size:function(){return Math.round(100*this.file.size/1024/1024)/100},shortName:function(){var e=this.file.filename;return e||(e=""),e.length>20?"".concat(e.slice(0,20),"..."):e}}},Cn=kn,wn=(n("4cd7"),Object(k["a"])(Cn,gn,yn,!1,null,"1e0ec97e",null)),Sn=wn.exports,xn={name:"Files",components:{appFile:Sn},props:{files:{type:Array}},data:function(){return{visibility:!1}}},jn=xn,On=Object(k["a"])(jn,vn,bn,!1,null,null,null),Rn=On.exports,_n={name:"Message",props:{message:String},components:{appAudio:mn,appFiles:Rn},data:function(){return{}},computed:{hasFiles:function(){return!!this.message.files&&!!this.message.files.length},hasAudio:function(){return!!this.message.audio},attached:function(){return this.hasAudio||this.hasFiles},isUserMessage:function(){return this.message.user===this.$store.state.chatData.user._id},usernameClass:function(){return this.isUserMessage?"order-0":"order-12"},chatHistory:function(){return this.$store.getters.currentChatHistory},username:function(){if(!this.message)return"";var e=this.$store.getters.usernameById(this.message.user);return e||""},initials:function(){return this.username?"string"!==typeof this.username?"":this.username.split(" ").map((function(e){return e.toUpperCase()[0]})).splice(0,2).join(""):""}}},En=_n,In=(n("f28b"),Object(k["a"])(En,sn,on,!1,null,"4000006b",null)),Tn=In.exports,$n={name:"ChatHistory",data:function(){return{scrollTop:this.historyHeight,userScrolling:!1,userScrollingTimeout:void 0,fullHistoryLoaded:!1,previousHistorySize:null,previousStartMessageId:void 0,autoScroll:!1}},computed:{historyHeight:function(){return this.historyElement.scrollHeight+1e4},currentChat:function(){return this.$store.state.chatData.currentChatId},chatHistory:function(){return this.$store.getters.currentChatHistory},isHistoryFull:function(){return this.$store.getters.isHistoryFull},historySize:function(){return this.chatHistory.length},historyElement:function(){return this.$refs.chatHistory}},components:{appMessage:Tn},methods:{isScrolledToEnd:function(){var e=this.historyElement.scrollHeight-this.historyElement.scrollTop;return e<=this.historyElement.clientHeight},scrollHistoryToEnd:function(){this.userScrolling||this.historyElement&&this.historyElement.children.length&&(this.historyElement.children[this.historySize-1].scrollIntoView(),this.autoScroll=!0)},scrollToPreviousStart:function(){this.historyElement&&this.historyElement.children.length&&null!==this.previousHistorySize&&(this.autoScroll=!0,this.userScrolling=!1,this.previousStartMessageId=null,this.historyElement.children[this.historySize-this.previousHistorySize].scrollIntoView(),this.previousHistorySize=null)},onUserInput:function(){this.userScrolling=!0},onScroll:function(){var e=this;return Object(j["a"])(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!e.isScrolledToEnd()){t.next=3;break}return t.next=3,e.$store.dispatch("clearUnreadMessagesCount");case 3:if(e.autoScroll&&(e.autoScroll=!1),!e.userScrolling){t.next=13;break}if(!(e.historyElement.scrollTop<=0)||e.isHistoryFull){t.next=11;break}if(!e.historySize){t.next=11;break}return e.previousStartMessageId=e.chatHistory[0]._id,e.previousHistorySize=e.historySize,t.next=11,e.$store.dispatch("getHistoryChunk");case 11:e.userScrollingTimeout&&clearTimeout(e.userScrollingTimeout),e.userScrollingTimeout=setTimeout((function(){e.userScrolling=!1}),ze);case 13:case"end":return t.stop()}}),t)})))()}},destroyed:function(){this.userScrollingTimeout&&clearTimeout(this.userScrollingTimeout)},updated:function(){var e=this;return Object(j["a"])(regeneratorRuntime.mark((function t(){var n;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!e.isScrolledToEnd()){t.next=3;break}return t.next=3,e.$store.dispatch("clearUnreadMessagesCount");case 3:n=e.chatHistory.length&&e.previousStartMessageId&&e.previousStartMessageId!==e.chatHistory[0]._id,n?e.scrollToPreviousStart():e.scrollHistoryToEnd();case 5:case"end":return t.stop()}}),t)})))()}},An=$n,Mn=(n("918f"),Object(k["a"])(An,rn,an,!1,null,"49abf449",null)),Pn=Mn.exports,Un=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("section",{staticClass:"new-message my-2"},[n("b-input-group",{scopedSlots:e._u([{key:"prepend",fn:function(){return[n("b-button",{attrs:{variant:"outline-info"},on:{click:function(t){e.attachVisibility=!e.attachVisibility}}},[n("b-icon",{attrs:{icon:"paperclip",scale:"2"}})],1)]},proxy:!0}])},[n("b-form-textarea",{on:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.onSend(t)},input:e.onInput,change:e.onBlur},model:{value:e.newMessage,callback:function(t){e.newMessage=t},expression:"newMessage"}}),n("b-input-group-append",[n("b-button",{attrs:{variant:"outline-info"},on:{click:e.onSend}},[n("b-icon",{attrs:{icon:"cursor",scale:"2"}})],1)],1)],1),n("b-collapse",{model:{value:e.attachVisibility,callback:function(t){e.attachVisibility=t},expression:"attachVisibility"}},[n("app-audio",{staticClass:"mt-2"}),n("app-files",{staticClass:"mt-2"})],1)],1)},Ln=[],Vn=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"d-flex flex-row justify-content-end"},[n("app-mic",{staticClass:"mr-2"}),n("app-play",{staticClass:"mr-2"}),n("app-delete")],1)},Nn=[],Fn=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("b-button",{staticClass:"mic",attrs:{variant:"outline-info"},on:{click:e.toggleRecorder}},[n("b-icon",{attrs:{icon:"mic-fill",scale:"1",animation:e.buttonEffect}}),n("p",[e._v(e._s(e.recordedTime))]),e.formattedLimitTime?n("p",[e._v(e._s("/ "+e.formattedLimitTime))]):e._e()],1)},Dn=[],Hn=(n("a9e3"),{props:{format:{type:String,default:"mp3"},timeLimit:{type:Number,default:2},bitRate:{type:Number,default:128},sampleRate:{type:Number,default:44100},micFailed:{type:Function}},data:function(){return{isUploading:!1,currentRecord:null}},beforeMount:function(){this.initRecorder()},beforeDestroy:function(){this.stopRecorder()},methods:{toggleRecorder:function(){this.isRecording?this.stopRecorder():this.startRecorder()},startRecorder:function(){this.isRecording||(this.$store.commit("saveRecord",null),this.$store.commit("stopPlay"),this.recorder.start(),this.$store.commit("setRecorderState",this.isRecording))},stopRecorder:function(){this.isRecording&&(this.recorder.stop(),this.$store.commit("saveRecord",this.recorder.record),this.$store.commit("setRecorderState",this.isRecording))},removeRecord:function(){this.record=void 0},initRecorder:function(){this.$store.commit("initRecorder",{micFailed:this.micFailed,bitRate:this.bitRate,sampleRate:this.sampleRate,format:this.format})}},computed:{recorder:function(){return this.$store.state.audio.recorder},isPause:function(){return this.recorder.isPause},buttonEffect:function(){return this.isRecording?"fade":""},isRecording:function(){return this.recorder.isRecording},duration:function(){return this.recorder.duration},recordedTime:function(){return this.timeLimit&&this.duration>=60*this.timeLimit&&this.stopRecorder(),b(this.duration)},formattedLimitTime:function(){return this.timeLimit?b(60*this.timeLimit):""}}}),zn=Hn,Bn=(n("e972"),Object(k["a"])(zn,Fn,Dn,!1,null,"ed0d3392",null)),qn=Bn.exports,Gn=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("b-button",{staticClass:"play",attrs:{variant:"outline-info",disabled:!e.downloadLink},on:{click:e.onPlay}},[n("b-icon",{attrs:{icon:e.icon,scale:"1",animation:e.iconAnimation}}),e.downloadLink?n("p",[e._v(e._s(e.playedTime))]):e._e(),e.downloadLink?n("p",[e._v(e._s("/ "+e.duration))]):e._e()],1)},Wn=[],Yn={props:{icon:{type:String,default:"play-fill"}},data:function(){return{}},beforeDestroy:function(){var e=this;return Object(j["a"])(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:e.isOnPlayer&&e.$store.commit("stopPlay");case 1:case"end":return t.stop()}}),t)})))()},computed:{iconAnimation:function(){return this.isPlaying&&this.isOnPlayer?"fade":void 0},isPlaying:function(){return this.$store.state.audio.isPlaying},playerSource:function(){return this.$store.state.audio.playerSource},isOnPlayer:function(){return!!this.downloadLink&&this.downloadLink===this.playerSource},downloadLink:function(){if(this.$store.state.audio.currentRecord)return this.$store.state.audio.currentRecord.url},playedTime:function(){return this.isOnPlayer?this.$store.state.audio.playedTime:b(0)},duration:function(){return this.downloadLink?this.$store.state.audio.currentRecord.duration:b(0)}},methods:{onPlay:function(){this.downloadLink&&this.$store.commit("startStopPlay",this.downloadLink)}}},Jn=Yn,Qn=(n("bf32"),Object(k["a"])(Jn,Gn,Wn,!1,null,"4ea01b1c",null)),Kn=Qn.exports,Xn=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("b-button",{staticClass:"delete-record",attrs:{disabled:!e.currentRecord,variant:"outline-info"},on:{click:e.deleteRecord}},[n("b-icon",{attrs:{icon:"x-circle-fill",scale:"1"}})],1)},Zn=[],er={data:function(){return{}},methods:{deleteRecord:function(){this.isOnPlayer&&this.$store.dispatch("stopPlay"),this.$store.commit("saveRecord",null)}},computed:{isOnPlayer:function(){return!!this.downloadLink&&this.downloadLink===this.playerSource},playerSource:function(){return this.$store.state.audio.playerSource},downloadLink:function(){if(this.currentRecord)return this.currentRecord.url},currentRecord:function(){return this.$store.state.audio.currentRecord}}},tr=er,nr=(n("a184"),Object(k["a"])(tr,Xn,Zn,!1,null,"321e4607",null)),rr=nr.exports,ar={name:"AttachingAudio",data:function(){return{}},components:{appMic:qn,appPlay:Kn,appDelete:rr}},ir=ar,sr=Object(k["a"])(ir,Vn,Nn,!1,null,null,null),or=sr.exports,cr=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[n("app-attach-file"),n("app-attached-files")],1)},ur=[],lr=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("b-form-file",{attrs:{multiple:"","file-name-formatter":e.getFormatNames,placeholder:"Choose a file or drop it here...","drop-placeholder":"Drop file here...",variant:"outline-info"},on:{input:e.onInput},model:{value:e.files,callback:function(t){e.files=t},expression:"files"}})},hr=[],fr={name:"AttachFile",data:function(){return{files:[]}},methods:{onInput:function(){this.$store.commit("setAttachedFiles",this.files)},getFormatNames:function(){var e=this.files?this.files.length:0;return 1===e?this.files[0].name:"".concat(e," files selected")}},computed:{attachedFiles:function(){return this.$store.state.ui.attachedFiles}},watch:{attachedFiles:function(){this.files=Object(J["a"])(this.attachedFiles)}}},dr=fr,pr=(n("8a0d"),Object(k["a"])(dr,lr,hr,!1,null,"2bb5d4d0",null)),mr=pr.exports,vr=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"w-100 d-flex flex-wrap"},e._l(e.attachedFiles,(function(e,t){return n("app-file",{key:t,staticClass:"ml-2 mt-2",attrs:{file:e,index:t}})})),1)},br=[],gr=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("b-button",{staticClass:"d-flex flex-row align-items-center",attrs:{variant:"outline-secondary"},on:{click:e.onDelete}},[n("p",{staticClass:"mr-2"},[e._v(e._s(e.shortName))]),n("b-icon",{attrs:{icon:"x",variant:"danger",scale:"2"}})],1)},yr=[],kr={name:"FileName",props:{file:{type:Object},index:{type:Number}},data:function(){return{files:void 0}},methods:{onDelete:function(){var e=Object(J["a"])(this.attachedFiles);e.splice(this.index,1),this.$store.commit("setAttachedFiles",e)}},computed:{attachedFiles:function(){return this.$store.state.ui.attachedFiles},shortName:function(){return this.file.name.length>30?"".concat(this.file.name.slice(0,30),"..."):this.file.name}}},Cr=kr,wr=(n("b3db"),Object(k["a"])(Cr,gr,yr,!1,null,"097e69ae",null)),Sr=wr.exports,xr={name:"AttachedFiles",data:function(){return{}},components:{appFile:Sr},computed:{attachedFiles:function(){return this.$store.state.ui.attachedFiles}}},jr=xr,Or=(n("399c"),Object(k["a"])(jr,vr,br,!1,null,"403e3491",null)),Rr=Or.exports,_r={name:"AttachingFiles",data:function(){return{}},components:{appAttachFile:mr,appAttachedFiles:Rr}},Er=_r,Ir=Object(k["a"])(Er,cr,ur,!1,null,null,null),Tr=Ir.exports;function $r(e){return new Promise((function(t,n){var r=new FileReader;r.onload=function(){t(r.result)},r.onerror=n,r.readAsArrayBuffer(e)}))}var Ar={name:"NewMessage",components:{appAudio:or,appFiles:Tr},data:function(){return{attachVisibility:!1,newMessage:this.draft?this.draft:""}},computed:{chatHistory:function(){return this.$store.getters.currentChatHistory},draft:function(){return this.$store.getters.currentDraft},virtualServer:function(){return this.$store.state.chatData.currentVirtualServerId},userStatus:function(){return this.$store.state.ui.userStatus.chat},chat:function(){return this.$store.state.chatData.currentChatId},chatClient:function(){return this.$store.state.chatEngine.chatClient},attachedFiles:function(){return this.$store.state.ui.attachedFiles},hasFiles:function(){return!!this.attachedFiles&&!!this.attachedFiles.length},currentRecord:function(){return this.$store.state.audio.currentRecord}},watch:{attachedFiles:function(e){var t=this;if(e&&e.length){var n=e.filter((function(e){return e.size>1024*Be*1024}));if(n.length){n.forEach((function(e,n){setTimeout((function(){t.$store.commit("postNotification",{title:"File is too big! Max Size: ".concat(Be," Mb"),message:"File: ".concat(e.name," size: ").concat(Math.round(e.size/1024/1024)," Mb")})}),250*n)}));var r=e.filter((function(e){return e.size<=1024*Be*1024}));this.$store.commit("setAttachedFiles",r)}}}},methods:{onBlur:function(){var e=this;return Object(j["a"])(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return e.$store.commit("updateDraft",e.newMessage),t.next=3,e.$store.dispatch("updateUserChatStatus",void 0);case 3:case"end":return t.stop()}}),t)})))()},onInput:function(){var e=this;return Object(j["a"])(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.userStatus===e.chat){t.next=3;break}return t.next=3,e.$store.dispatch("updateUserChatStatus",e.chat);case 3:case"end":return t.stop()}}),t)})))()},onSend:function(){var e=this;return Object(j["a"])(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.newMessage||e.currentRecord||e.hasFiles){t.next=3;break}return e.$store.commit("postNotification",{message:"Oops... We have nothing to send!"}),t.abrupt("return");case 3:return t.next=5,e.send();case 5:if(!t.sent){t.next=13;break}return e.newMessage="",t.next=9,e.$store.dispatch("afterMessageSending");case 9:e.$store.commit("updateDraft",e.newMessage),e.attachVisibility=!1,t.next=14;break;case 13:e.$store.commit("postNotification",{error:!0,message:"Message was not sent!",title:"Attention. Error!"});case 14:case"end":return t.stop()}}),t)})))()},send:function(){var e=this;return Object(j["a"])(regeneratorRuntime.mark((function t(){var n,r,a,i,s,o;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n=e.chat.slice(),r=e.newMessage,t.prev=2,!e.currentRecord){t.next=11;break}return t.t0=e.currentRecord.type,t.next=7,e.currentRecord.blob.arrayBuffer();case 7:t.t1=t.sent,t.t2=e.currentRecord.size,t.t3=e.currentRecord.duration,a={type:t.t0,audio:t.t1,size:t.t2,duration:t.t3};case 11:t.next=16;break;case 13:return t.prev=13,t.t4=t["catch"](2),t.abrupt("return",!1);case 16:if(i=e.attachedFiles,i&&(i=i.length?i:void 0),!i){t.next=22;break}return t.next=21,Promise.all(i.map((function(e){return $r(e).then((function(t){return{filename:e.name,file:t,size:e.size}}))})));case 21:i=t.sent;case 22:return s={chat:n,text:r,audio:a,files:i},t.prev=23,t.next=26,e.chatClient.sendFullMessage(e.virtualServer,e.chat,s);case 26:o=t.sent,t.next=32;break;case 29:return t.prev=29,t.t5=t["catch"](23),t.abrupt("return",!1);case 32:if(o&&!o.error){t.next=34;break}return t.abrupt("return",!1);case 34:return t.abrupt("return",!0);case 35:case"end":return t.stop()}}),t,null,[[2,13],[23,29]])})))()}}},Mr=Ar,Pr=Object(k["a"])(Mr,Un,Ln,!1,null,null,null),Ur=Pr.exports,Lr=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("section",{staticClass:"status my-2"},[n("b-alert",{attrs:{show:e.isActive,variant:"info"}},[e._v(e._s(e.statusString))])],1)},Vr=[],Nr={name:"Status",data:function(){return{}},computed:{isActive:function(){return!!this.statusArray.length},statusArray:function(){var e=this;return this.$store.getters.currentChatStatus.filter((function(t){return t!==e.userId}))},statusString:function(){var e=this;if(!this.statusArray.length)return"";var t=this.statusArray.map((function(t){return e.$store.getters.usernameById(t)})).filter((function(e){return e}));if(!t||!t.length)return"";var n=t.length>1;return"".concat(t.join(", ")," ").concat(n?"are writing":"is writing"," now. . .")},chat:function(){return this.$store.state.chatData.currentChatId},userId:function(){return this.$store.state.chatData.user._id}}},Fr=Nr,Dr=Object(k["a"])(Fr,Lr,Vr,!1,null,null,null),Hr=Dr.exports,zr={name:"Chat",components:{appHistory:Pn,appNewMessage:Ur,appStatus:Hr}},Br=zr,qr=Object(k["a"])(Br,tn,nn,!1,null,"1cbf3c90",null),Gr=qr.exports,Wr=function(){var e=this,t=e.$createElement;e._self._c;return e._m(0)},Yr=[function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("section",{staticClass:"voice-channel d-flex flex-column h-100"},[n("h2",[e._v("Voice channel")])])}],Jr={name:"VoiceChannel",components:{}},Qr=Jr,Kr=Object(k["a"])(Qr,Wr,Yr,!1,null,"687b2de8",null),Xr=Kr.exports;r["default"].use(F["a"]);var Zr=[{path:"",component:en,meta:{requiresAuth:!0},children:[{path:"",name:"home",redirect:{name:"chat"}},{path:"chat",component:Gr,name:"chat"},{path:"voice-channel",name:"voiceChannel",component:Xr}]},{path:"/sign-in",name:"signIn",component:et},{path:"/sign-up",name:"signUp",component:Ye},{path:"*",redirect:{name:"home"}}],ea=new F["a"]({mode:"history",base:"/",routes:Zr});ea.beforeEach((function(e,t,n){e.matched.some((function(e){return e.meta.requiresAuth}))&&!Pe.getters.isLoggedIn?n({name:"signIn"}):"/signIn"===e.path&&Pe.getters.isLoggedIn?n({name:"home"}):n()}));var ta=ea;r["default"].use(s["a"]),r["default"].use(o["a"]),r["default"].use(c["a"]),r["default"].use(u["a"]),r["default"].use(l["a"]),r["default"].use(h["a"]),r["default"].use(f["a"]),r["default"].config.productionTip=!1,r["default"].filter("myDate",(function(e){return e?i()(String(e)).format("DD.MM.YYYY hh:mm:ss"):""})),new r["default"]({router:ta,store:Pe,render:function(e){return e(N)}}).$mount("#app")},"5c0b":function(e,t,n){"use strict";n("9c0c")},"5e91":function(e,t,n){},"66e8":function(e,t,n){"use strict";n.r(t),n.d(t,"ACTIONS",(function(){return r})),n.d(t,"VOICE_CHANNEL_SERVICE_ACTIONS",(function(){return a})),n.d(t,"CONNECTION_STATUSES",(function(){return i})),n.d(t,"ICE_SERVER_URLS",(function(){return s}));var r={text:"text",messageHeader:"message-header",audioInfo:"audio-info",fileInfo:"file-info",binaryOk:"binary-ok",messageFooter:"message-footer",getHistory:"get-history",getChats:"get-chats",getVoiceChannels:"get-voice-channels",getContacts:"get-contacts",getContactsOnline:"get-contacts-online",status:"status",userInfo:"user-info",voiceChannelIce:"voice-channel-ice",voiceChannelOffer:"voice-channel-offer",voiceChannelAnswer:"voice-channel-answer",callRequest:"call-request",callResponse:"call-response"},a=[r.voiceChannelIce,r.voiceChannelOffer,r.voiceChannelAnswer],i={CLOSED:"closed",OPENING:"opening",OPENED:"opened",CLOSING:"CLOSING"},s=["stun:stun.l.google.com:19302"]},"749a":function(e,t,n){},"8a0d":function(e,t,n){"use strict";n("ebb2")},"918f":function(e,t,n){"use strict";n("e4fa")},"9c0c":function(e,t,n){},a184:function(e,t,n){"use strict";n("ca18")},b3db:function(e,t,n){"use strict";n("2cfa")},bf32:function(e,t,n){"use strict";n("f07e2")},c9d3:function(e,t,n){},ca18:function(e,t,n){},d850:function(e,t,n){},e120:function(e,t,n){},e4fa:function(e,t,n){},e972:function(e,t,n){"use strict";n("e120")},ebb2:function(e,t,n){},ebcb:function(e,t,n){"use strict";n("d850")},f07e2:function(e,t,n){},f28b:function(e,t,n){"use strict";n("749a")}});
//# sourceMappingURL=app.9dc5ae8b.js.map